'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _isInteger=require('babel-runtime/core-js/number/is-integer');var _isInteger2=_interopRequireDefault(_isInteger);var _keys=require('babel-runtime/core-js/object/keys');var _keys2=_interopRequireDefault(_keys);var _getIterator2=require('babel-runtime/core-js/get-iterator');var _getIterator3=_interopRequireDefault(_getIterator2);var _assign=require('babel-runtime/core-js/object/assign');var _assign2=_interopRequireDefault(_assign);var _from=require('babel-runtime/core-js/array/from');var _from2=_interopRequireDefault(_from);var _stringify=require('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _promise=require('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _classCallCheck2=require('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _xmlhttprequest=require('xmlhttprequest');var _xmmClient=require('xmm-client');var Xmm=_interopRequireWildcard(_xmmClient);var _rapidMixAdapters=require('rapid-mix-adapters');var _rapidMixAdapters2=_interopRequireDefault(_rapidMixAdapters);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var isNode=new Function("try {return this===global;}catch(e){return false;}");var knownTargets={xmm:['gmm','gmr','hhmm','hhmr']};var defaultXmmConfig={modelType:'gmm',gaussians:1,absoluteRegularization:0.01,relativeRegularization:0.01,covarianceMode:'full',hierarchical:true,states:1,transitionMode:'leftright',regressionEstimator:'full',likelihoodWindow:10};/**
 * Representation of a gesture model. A instance of `XmmProcessor` can
 * train a model from examples and can perform classification and/or
 * regression depending on the chosen algorithm.
 *
 * The training is currently based on the presence of a remote server-side
 * API, that must be able to process rapidMix compliant JSON formats.
 *
 * @param {Object} options - Override default parameters
 * @param {String} [options.url='https://como.ircam.fr/api/v1/train'] - Url
 *  of the training end point.
 *
 * @example
 * import * as mano from 'mano-js/client';
 *
 * const processedSensors = new mano.ProcessedSensors();
 * const example = new mano.Example();
 * const trainingSet = new mano.TrainingSet();
 * const xmmProcessor = new mano.XmmProcesssor();
 *
 * example.setLabel('test');
 * processedSensors.addListener(example.addElement);
 *
 * // later
 * processedSensors.removeListener(example.addElement);
 * const rapidMixJsonExample = example.toJSON();
 *
 * trainingSet.addExample(rapidMixJsonExample);
 * const rapidMixJsonTrainingSet = trainingSet.toJSON();
 *
 * xmmProcessor
 *   .train(rapidMixJsonTrainingSet)
 *   .then(() => {
 *     // start decoding
 *     processedSensors.addListener(data => {
 *       const results = xmmProcessor.run(data);
 *       console.log(results);
 *     });
 *   });
 */var XmmProcessor=function(){function XmmProcessor(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref$url=_ref.url,url=_ref$url===undefined?'https://como.ircam.fr/api/v1/train':_ref$url;(0,_classCallCheck3.default)(this,XmmProcessor);this.url=url;this._config={};this._decoder=null;this._model=null;this._modelType=null;this._likelihoodWindow=null;this.setConfig(defaultXmmConfig);this._setDecoder();}(0,_createClass3.default)(XmmProcessor,[{key:'_setDecoder',value:function _setDecoder(){switch(this._modelType){case'hhmm':this._decoder=new Xmm.HhmmDecoder(this._likelihoodWindow);break;case'gmm':default:this._decoder=new Xmm.GmmDecoder(this._likelihoodWindow);break;}}/**
   * Reset the model's temporal decoding state. Is only valid on `hhmm` decoder.
   */},{key:'reset',value:function reset(){if(this._decoder.reset)this._decoder.reset();}/**
   * Train the model according to the given `TrainingSet`. In this implmentation
   * the training is performed server-side and rely on an XHR call.
   *
   * @param {JSON} trainingSet - RapidMix compliant JSON formatted training set
   * @return {Promise} - Promise that resolves on the API response (RapidMix API
   *  response format), when the model is updated.
   */},{key:'train',value:function train(trainingSet){var _this=this;// REST request / response - RapidMix
return new _promise2.default(function(resolve,reject){var trainingData=_rapidMixAdapters2.default.createComoHttpRequest(_this.getConfig,trainingSet);// const trainingData = {
//   docType: 'rapid-mix:ml-http-request',
//   docVersion: rapidMixAdapters.RAPID_MIX_DOC_VERSION,
//   target: {
//     name: 'como-web-service',
//     version: '1.0.0'
//   }
//   payload: {
//     configuration: this.getConfig(),
//     trainingSet: trainingSet
//   }
// };
var xhr=isNode()?new _xmlhttprequest.XMLHttpRequest():new XMLHttpRequest();xhr.open('post',_this.url,true);xhr.responseType='json';xhr.setRequestHeader('Access-Control-Allow-Origin','*');xhr.setRequestHeader('Content-Type','application/json');var errorMsg='an error occured while training the model. ';if(isNode()){// XMLHttpRequest module only supports xhr v1
xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){var body=JSON.parse(xhr.responseText);_this._model=body.payload.model;_this._decoder.setModel(_this._model.payload);resolve(body);}else{throw new Error(errorMsg+('response : '+xhr.status+' - '+xhr.responseText));}}};}else{// use xhr v2
xhr.onload=function(){if(xhr.status===200){var body=xhr.response;_this._model=body.payload.model;_this._decoder.setModel(_this._model.payload);resolve(body);}else{throw new Error(errorMsg+('response : '+xhr.status+' - '+xhr.response));}};xhr.onerror=function(){throw new Error(errorMsg+('response : '+xhr.status+' - '+xhr.response));};}xhr.send((0,_stringify2.default)(trainingData));});}/**
   * Perform the calssification or the regression of the given vector.
   *
   * @param {Float32Array|Array} vector - Input vector for the decoding.
   * @return {Object} results - Object containing the decoding results.
   */},{key:'run',value:function run(vector){if(vector instanceof Float32Array||vector instanceof Float64Array){vector=(0,_from2.default)(vector);}return this._decoder.filter(vector);}/**
   * RapidMix compliant configuration object.
   *
   * @return {Object} - RapidMix Configuration object.
   */},{key:'getConfig',value:function getConfig(){return _rapidMixAdapters2.default.xmmToRapidMixConfiguration((0,_assign2.default)({},this._config,{modelType:this._modelType}));// return {
//   docType: 'rapid-mix:ml-configuration',
//   docVersion: rapidMixAdapters.RAPID_MIX_DOC_VERSION,
//   target: {
//     name: `xmm:${this._modelType}`,
//     version: '1.0.0'
//   },
//   payload: this._config,
// };
}/**
   * Set the model configuration parameters (or a subset of them).
   *
   * @param {Object} config - RapidMix configuration object (or payload), or subset of parameters.
   */},{key:'setConfig',value:function setConfig(){var config=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!config)return;// replace later by isValidRapidMixConfiguration (modelType shouldn't be allowed in payload)
if(config.docType==='rapid-mix:ml-configuration'&&config.docVersion&&config.payload&&config.target&&config.target.name&&config.target.name.split(':')[0]==='xmm'){var target=config.target.name.split(':');config=config.payload;if(target.length>1&&knownTargets.xmm.indexOf(target[1])>-1){if(this._modelType!==target[1]){this._modelType=target[1];this._setDecoder();}}}if(config.modelType&&knownTargets['xmm'].indexOf(config.modelType)>-1){var val=config.modelType;var newModel=val==='gmr'?'gmm':val==='hhmr'?'hhmm':val;if(newModel!==this._modelType){this._modelType=newModel;this._setDecoder();}}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=(0,_getIterator3.default)((0,_keys2.default)(config)),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var key=_step.value;var _val=config[key];if(key==='gaussians'&&(0,_isInteger2.default)(_val)&&_val>0||key==='absoluteRegularization'&&typeof _val==='number'&&_val>0||key==='relativeRegularization'&&typeof _val==='number'&&_val>0||key==='covarianceMode'&&typeof _val==='string'&&['full','diagonal'].indexOf(_val)>-1||key==='hierarchical'&&typeof _val==='boolean'||key==='states'&&(0,_isInteger2.default)(_val)&&_val>0||key==='transitionMode'&&typeof _val==='string'&&['leftright','ergodic'].indexOf(_val)>-1||key==='regressionEstimator'&&typeof _val==='string'&&['full','windowed','likeliest'].indexOf(_val)>-1){this._config[key]=_val;}else if(key==='likelihoodWindow'&&(0,_isInteger2.default)(_val)&&_val>0){this._likelihoodWindow=_val;if(this._decoder!==null){this._decoder.setLikelihoodWindow(this._likelihoodWindow);}}}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}}/**
   * Retrieve the model in RapidMix model format.
   *
   * @return {Object} - Current RapidMix Model object.
   */},{key:'getModel',value:function getModel(){return this._model;}/**
   * Use the given RapidMix model object for the decoding.
   *
   * @param {Object} model - RapidMix Model object.
   */},{key:'setModel',value:function setModel(model){if(!model){this.model=null;this._decoder.setModel(null);return;}var targets=model.target.name.split(':');var lib=targets[0];var algo=targets[1];if(lib==='xmm'){this._modelType=algo==='hhmm'?algo:'gmm';this._setDecoder();this._model=model;// this._decoder.setModel(model.payload);
this._decoder.setModel(_rapidMixAdapters2.default.rapidMixToXmmModel(model));}else{throw new Error('Invalid type '+lib);}}}]);return XmmProcessor;}();exports.default=XmmProcessor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIlhtbSIsImlzTm9kZSIsIkZ1bmN0aW9uIiwia25vd25UYXJnZXRzIiwieG1tIiwiZGVmYXVsdFhtbUNvbmZpZyIsIm1vZGVsVHlwZSIsImdhdXNzaWFucyIsImFic29sdXRlUmVndWxhcml6YXRpb24iLCJyZWxhdGl2ZVJlZ3VsYXJpemF0aW9uIiwiY292YXJpYW5jZU1vZGUiLCJoaWVyYXJjaGljYWwiLCJzdGF0ZXMiLCJ0cmFuc2l0aW9uTW9kZSIsInJlZ3Jlc3Npb25Fc3RpbWF0b3IiLCJsaWtlbGlob29kV2luZG93IiwiWG1tUHJvY2Vzc29yIiwidXJsIiwiX2NvbmZpZyIsIl9kZWNvZGVyIiwiX21vZGVsIiwiX21vZGVsVHlwZSIsIl9saWtlbGlob29kV2luZG93Iiwic2V0Q29uZmlnIiwiX3NldERlY29kZXIiLCJIaG1tRGVjb2RlciIsIkdtbURlY29kZXIiLCJyZXNldCIsInRyYWluaW5nU2V0IiwicmVzb2x2ZSIsInJlamVjdCIsInRyYWluaW5nRGF0YSIsImNyZWF0ZUNvbW9IdHRwUmVxdWVzdCIsImdldENvbmZpZyIsInhociIsIlhNTEh0dHBSZXF1ZXN0Iiwib3BlbiIsInJlc3BvbnNlVHlwZSIsInNldFJlcXVlc3RIZWFkZXIiLCJlcnJvck1zZyIsIm9ucmVhZHlzdGF0ZWNoYW5nZSIsInJlYWR5U3RhdGUiLCJzdGF0dXMiLCJib2R5IiwiSlNPTiIsInBhcnNlIiwicmVzcG9uc2VUZXh0IiwicGF5bG9hZCIsIm1vZGVsIiwic2V0TW9kZWwiLCJFcnJvciIsIm9ubG9hZCIsInJlc3BvbnNlIiwib25lcnJvciIsInNlbmQiLCJ2ZWN0b3IiLCJGbG9hdDMyQXJyYXkiLCJGbG9hdDY0QXJyYXkiLCJmaWx0ZXIiLCJ4bW1Ub1JhcGlkTWl4Q29uZmlndXJhdGlvbiIsImNvbmZpZyIsImRvY1R5cGUiLCJkb2NWZXJzaW9uIiwidGFyZ2V0IiwibmFtZSIsInNwbGl0IiwibGVuZ3RoIiwiaW5kZXhPZiIsInZhbCIsIm5ld01vZGVsIiwia2V5Iiwic2V0TGlrZWxpaG9vZFdpbmRvdyIsInRhcmdldHMiLCJsaWIiLCJhbGdvIiwicmFwaWRNaXhUb1htbU1vZGVsIl0sIm1hcHBpbmdzIjoiMmlDQUFBLDhDQUNBLHFDLEdBQVlBLEkscUNBQ1osb0QsOFhBRUEsR0FBTUMsUUFBUyxHQUFJQyxTQUFKLENBQWEsb0RBQWIsQ0FBZixDQUVBLEdBQU1DLGNBQWUsQ0FDbkJDLElBQUssQ0FBRSxLQUFGLENBQVMsS0FBVCxDQUFnQixNQUFoQixDQUF3QixNQUF4QixDQURjLENBQXJCLENBSUEsR0FBTUMsa0JBQW1CLENBQ3ZCQyxVQUFXLEtBRFksQ0FFdkJDLFVBQVcsQ0FGWSxDQUd2QkMsdUJBQXdCLElBSEQsQ0FJdkJDLHVCQUF3QixJQUpELENBS3ZCQyxlQUFnQixNQUxPLENBTXZCQyxhQUFjLElBTlMsQ0FPdkJDLE9BQVEsQ0FQZSxDQVF2QkMsZUFBZ0IsV0FSTyxDQVN2QkMsb0JBQXFCLE1BVEUsQ0FVdkJDLGlCQUFrQixFQVZLLENBQXpCLENBYUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztNQXdDTUMsYSxZQUNKLHVCQUVRLG9FQUFKLEVBQUksZUFETkMsR0FDTSxDQUROQSxHQUNNLHNCQURBLG9DQUNBLDBEQUNOLEtBQUtBLEdBQUwsQ0FBV0EsR0FBWCxDQUVBLEtBQUtDLE9BQUwsQ0FBZSxFQUFmLENBQ0EsS0FBS0MsUUFBTCxDQUFnQixJQUFoQixDQUNBLEtBQUtDLE1BQUwsQ0FBYyxJQUFkLENBQ0EsS0FBS0MsVUFBTCxDQUFrQixJQUFsQixDQUNBLEtBQUtDLGlCQUFMLENBQXlCLElBQXpCLENBRUEsS0FBS0MsU0FBTCxDQUFlbEIsZ0JBQWYsRUFDQSxLQUFLbUIsV0FBTCxHQUNELEMsdUZBRWEsQ0FDWixPQUFRLEtBQUtILFVBQWIsRUFDRSxJQUFLLE1BQUwsQ0FDRSxLQUFLRixRQUFMLENBQWdCLEdBQUluQixLQUFJeUIsV0FBUixDQUFvQixLQUFLSCxpQkFBekIsQ0FBaEIsQ0FDQSxN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aW1wb3J0IHsgWE1MSHR0cFJlcXVlc3QgYXMgWEhSIH0gZnJvbSAneG1saHR0cHJlcXVlc3QnO1xuaW1wb3J0ICogYXMgWG1tIGZyb20gJ3htbS1jbGllbnQnO1xuaW1wb3J0IHJhcGlkTWl4QWRhcHRlcnMgZnJvbSAncmFwaWQtbWl4LWFkYXB0ZXJzJztcblxuY29uc3QgaXNOb2RlID0gbmV3IEZ1bmN0aW9uKFwidHJ5IHtyZXR1cm4gdGhpcz09PWdsb2JhbDt9Y2F0Y2goZSl7cmV0dXJuIGZhbHNlO31cIik7XG5cbmNvbnN0IGtub3duVGFyZ2V0cyA9IHtcbiAgeG1tOiBbICdnbW0nLCAnZ21yJywgJ2hobW0nLCAnaGhtcicgXVxufTtcblxuY29uc3QgZGVmYXVsdFhtbUNvbmZpZyA9IHtcbiAgbW9kZWxUeXBlOiAnZ21tJyxcbiAgZ2F1c3NpYW5zOiAxLFxuICBhYnNvbHV0ZVJlZ3VsYXJpemF0aW9uOiAwLjAxLFxuICByZWxhdGl2ZVJlZ3VsYXJpemF0aW9uOiAwLjAxLFxuICBjb3ZhcmlhbmNlTW9kZTogJ2Z1bGwnLFxuICBoaWVyYXJjaGljYWw6IHRydWUsXG4gIHN0YXRlczogMSxcbiAgdHJhbnNpdGlvbk1vZGU6ICdsZWZ0cmlnaHQnLFxuICByZWdyZXNzaW9uRXN0aW1hdG9yOiAnZnVsbCcsXG4gIGxpa2VsaWhvb2RXaW5kb3c6IDEwLFxufTtcblxuLyoqXG4gKiBSZXByZXNlbnRhdGlvbiBvZiBhIGdlc3R1cmUgbW9kZWwuIEEgaW5zdGFuY2Ugb2YgYFhtbVByb2Nlc3NvcmAgY2FuXG4gKiB0cmFpbiBhIG1vZGVsIGZyb20gZXhhbXBsZXMgYW5kIGNhbiBwZXJmb3JtIGNsYXNzaWZpY2F0aW9uIGFuZC9vclxuICogcmVncmVzc2lvbiBkZXBlbmRpbmcgb24gdGhlIGNob3NlbiBhbGdvcml0aG0uXG4gKlxuICogVGhlIHRyYWluaW5nIGlzIGN1cnJlbnRseSBiYXNlZCBvbiB0aGUgcHJlc2VuY2Ugb2YgYSByZW1vdGUgc2VydmVyLXNpZGVcbiAqIEFQSSwgdGhhdCBtdXN0IGJlIGFibGUgdG8gcHJvY2VzcyByYXBpZE1peCBjb21wbGlhbnQgSlNPTiBmb3JtYXRzLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gT3ZlcnJpZGUgZGVmYXVsdCBwYXJhbWV0ZXJzXG4gKiBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMudXJsPSdodHRwczovL2NvbW8uaXJjYW0uZnIvYXBpL3YxL3RyYWluJ10gLSBVcmxcbiAqICBvZiB0aGUgdHJhaW5pbmcgZW5kIHBvaW50LlxuICpcbiAqIEBleGFtcGxlXG4gKiBpbXBvcnQgKiBhcyBtYW5vIGZyb20gJ21hbm8tanMvY2xpZW50JztcbiAqXG4gKiBjb25zdCBwcm9jZXNzZWRTZW5zb3JzID0gbmV3IG1hbm8uUHJvY2Vzc2VkU2Vuc29ycygpO1xuICogY29uc3QgZXhhbXBsZSA9IG5ldyBtYW5vLkV4YW1wbGUoKTtcbiAqIGNvbnN0IHRyYWluaW5nU2V0ID0gbmV3IG1hbm8uVHJhaW5pbmdTZXQoKTtcbiAqIGNvbnN0IHhtbVByb2Nlc3NvciA9IG5ldyBtYW5vLlhtbVByb2Nlc3Nzb3IoKTtcbiAqXG4gKiBleGFtcGxlLnNldExhYmVsKCd0ZXN0Jyk7XG4gKiBwcm9jZXNzZWRTZW5zb3JzLmFkZExpc3RlbmVyKGV4YW1wbGUuYWRkRWxlbWVudCk7XG4gKlxuICogLy8gbGF0ZXJcbiAqIHByb2Nlc3NlZFNlbnNvcnMucmVtb3ZlTGlzdGVuZXIoZXhhbXBsZS5hZGRFbGVtZW50KTtcbiAqIGNvbnN0IHJhcGlkTWl4SnNvbkV4YW1wbGUgPSBleGFtcGxlLnRvSlNPTigpO1xuICpcbiAqIHRyYWluaW5nU2V0LmFkZEV4YW1wbGUocmFwaWRNaXhKc29uRXhhbXBsZSk7XG4gKiBjb25zdCByYXBpZE1peEpzb25UcmFpbmluZ1NldCA9IHRyYWluaW5nU2V0LnRvSlNPTigpO1xuICpcbiAqIHhtbVByb2Nlc3NvclxuICogICAudHJhaW4ocmFwaWRNaXhKc29uVHJhaW5pbmdTZXQpXG4gKiAgIC50aGVuKCgpID0+IHtcbiAqICAgICAvLyBzdGFydCBkZWNvZGluZ1xuICogICAgIHByb2Nlc3NlZFNlbnNvcnMuYWRkTGlzdGVuZXIoZGF0YSA9PiB7XG4gKiAgICAgICBjb25zdCByZXN1bHRzID0geG1tUHJvY2Vzc29yLnJ1bihkYXRhKTtcbiAqICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdHMpO1xuICogICAgIH0pO1xuICogICB9KTtcbiAqL1xuY2xhc3MgWG1tUHJvY2Vzc29yIHtcbiAgY29uc3RydWN0b3Ioe1xuICAgIHVybCA9ICdodHRwczovL2NvbW8uaXJjYW0uZnIvYXBpL3YxL3RyYWluJyxcbiAgfSA9IHt9KSB7XG4gICAgdGhpcy51cmwgPSB1cmw7XG5cbiAgICB0aGlzLl9jb25maWcgPSB7fTtcbiAgICB0aGlzLl9kZWNvZGVyID0gbnVsbDtcbiAgICB0aGlzLl9tb2RlbCA9IG51bGw7XG4gICAgdGhpcy5fbW9kZWxUeXBlID0gbnVsbDtcbiAgICB0aGlzLl9saWtlbGlob29kV2luZG93ID0gbnVsbDtcblxuICAgIHRoaXMuc2V0Q29uZmlnKGRlZmF1bHRYbW1Db25maWcpO1xuICAgIHRoaXMuX3NldERlY29kZXIoKTtcbiAgfVxuXG4gIF9zZXREZWNvZGVyKCkge1xuICAgIHN3aXRjaCAodGhpcy5fbW9kZWxUeXBlKSB7XG4gICAgICBjYXNlICdoaG1tJzpcbiAgICAgICAgdGhpcy5fZGVjb2RlciA9IG5ldyBYbW0uSGhtbURlY29kZXIodGhpcy5fbGlrZWxpaG9vZFdpbmRvdyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnZ21tJzpcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMuX2RlY29kZXIgPSBuZXcgWG1tLkdtbURlY29kZXIodGhpcy5fbGlrZWxpaG9vZFdpbmRvdyk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldCB0aGUgbW9kZWwncyB0ZW1wb3JhbCBkZWNvZGluZyBzdGF0ZS4gSXMgb25seSB2YWxpZCBvbiBgaGhtbWAgZGVjb2Rlci5cbiAgICovXG4gIHJlc2V0KCkge1xuICAgIGlmICh0aGlzLl9kZWNvZGVyLnJlc2V0KVxuICAgICAgdGhpcy5fZGVjb2Rlci5yZXNldCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYWluIHRoZSBtb2RlbCBhY2NvcmRpbmcgdG8gdGhlIGdpdmVuIGBUcmFpbmluZ1NldGAuIEluIHRoaXMgaW1wbG1lbnRhdGlvblxuICAgKiB0aGUgdHJhaW5pbmcgaXMgcGVyZm9ybWVkIHNlcnZlci1zaWRlIGFuZCByZWx5IG9uIGFuIFhIUiBjYWxsLlxuICAgKlxuICAgKiBAcGFyYW0ge0pTT059IHRyYWluaW5nU2V0IC0gUmFwaWRNaXggY29tcGxpYW50IEpTT04gZm9ybWF0dGVkIHRyYWluaW5nIHNldFxuICAgKiBAcmV0dXJuIHtQcm9taXNlfSAtIFByb21pc2UgdGhhdCByZXNvbHZlcyBvbiB0aGUgQVBJIHJlc3BvbnNlIChSYXBpZE1peCBBUElcbiAgICogIHJlc3BvbnNlIGZvcm1hdCksIHdoZW4gdGhlIG1vZGVsIGlzIHVwZGF0ZWQuXG4gICAqL1xuICB0cmFpbih0cmFpbmluZ1NldCkge1xuICAgIC8vIFJFU1QgcmVxdWVzdCAvIHJlc3BvbnNlIC0gUmFwaWRNaXhcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgdHJhaW5pbmdEYXRhID0gcmFwaWRNaXhBZGFwdGVycy5jcmVhdGVDb21vSHR0cFJlcXVlc3QodGhpcy5nZXRDb25maWcsIHRyYWluaW5nU2V0KTtcblxuICAgICAgLy8gY29uc3QgdHJhaW5pbmdEYXRhID0ge1xuICAgICAgLy8gICBkb2NUeXBlOiAncmFwaWQtbWl4Om1sLWh0dHAtcmVxdWVzdCcsXG4gICAgICAvLyAgIGRvY1ZlcnNpb246IHJhcGlkTWl4QWRhcHRlcnMuUkFQSURfTUlYX0RPQ19WRVJTSU9OLFxuICAgICAgLy8gICB0YXJnZXQ6IHtcbiAgICAgIC8vICAgICBuYW1lOiAnY29tby13ZWItc2VydmljZScsXG4gICAgICAvLyAgICAgdmVyc2lvbjogJzEuMC4wJ1xuICAgICAgLy8gICB9XG4gICAgICAvLyAgIHBheWxvYWQ6IHtcbiAgICAgIC8vICAgICBjb25maWd1cmF0aW9uOiB0aGlzLmdldENvbmZpZygpLFxuICAgICAgLy8gICAgIHRyYWluaW5nU2V0OiB0cmFpbmluZ1NldFxuICAgICAgLy8gICB9XG4gICAgICAvLyB9O1xuXG4gICAgICBjb25zdCB4aHIgPSBpc05vZGUoKSA/IG5ldyBYSFIoKSA6IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuXG4gICAgICB4aHIub3BlbigncG9zdCcsIHRoaXMudXJsLCB0cnVlKTtcbiAgICAgIHhoci5yZXNwb25zZVR5cGUgPSAnanNvbic7XG4gICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcbiAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuXG4gICAgICBjb25zdCBlcnJvck1zZyA9ICdhbiBlcnJvciBvY2N1cmVkIHdoaWxlIHRyYWluaW5nIHRoZSBtb2RlbC4gJztcblxuICAgICAgaWYgKGlzTm9kZSgpKSB7IC8vIFhNTEh0dHBSZXF1ZXN0IG1vZHVsZSBvbmx5IHN1cHBvcnRzIHhociB2MVxuICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gKCkgPT4ge1xuICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PT0gNCkge1xuICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgICAgdGhpcy5fbW9kZWwgPSBib2R5LnBheWxvYWQubW9kZWw7XG4gICAgICAgICAgICAgIHRoaXMuX2RlY29kZXIuc2V0TW9kZWwodGhpcy5fbW9kZWwucGF5bG9hZCk7XG4gICAgICAgICAgICAgIHJlc29sdmUoYm9keSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cgKyBgcmVzcG9uc2UgOiAke3hoci5zdGF0dXN9IC0gJHt4aHIucmVzcG9uc2VUZXh0fWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHsgLy8gdXNlIHhociB2MlxuICAgICAgICB4aHIub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgIGNvbnN0IGJvZHkgPSB4aHIucmVzcG9uc2U7XG4gICAgICAgICAgICB0aGlzLl9tb2RlbCA9IGJvZHkucGF5bG9hZC5tb2RlbDtcbiAgICAgICAgICAgIHRoaXMuX2RlY29kZXIuc2V0TW9kZWwodGhpcy5fbW9kZWwucGF5bG9hZCk7XG4gICAgICAgICAgICByZXNvbHZlKGJvZHkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cgKyBgcmVzcG9uc2UgOiAke3hoci5zdGF0dXN9IC0gJHt4aHIucmVzcG9uc2V9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHhoci5vbmVycm9yID0gKCkgPT4ge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1zZyArIGByZXNwb25zZSA6ICR7eGhyLnN0YXR1c30gLSAke3hoci5yZXNwb25zZX1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB4aHIuc2VuZChKU09OLnN0cmluZ2lmeSh0cmFpbmluZ0RhdGEpKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIHRoZSBjYWxzc2lmaWNhdGlvbiBvciB0aGUgcmVncmVzc2lvbiBvZiB0aGUgZ2l2ZW4gdmVjdG9yLlxuICAgKlxuICAgKiBAcGFyYW0ge0Zsb2F0MzJBcnJheXxBcnJheX0gdmVjdG9yIC0gSW5wdXQgdmVjdG9yIGZvciB0aGUgZGVjb2RpbmcuXG4gICAqIEByZXR1cm4ge09iamVjdH0gcmVzdWx0cyAtIE9iamVjdCBjb250YWluaW5nIHRoZSBkZWNvZGluZyByZXN1bHRzLlxuICAgKi9cbiAgcnVuKHZlY3Rvcikge1xuICAgIGlmICh2ZWN0b3IgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkgfHwgdmVjdG9yIGluc3RhbmNlb2YgRmxvYXQ2NEFycmF5KSB7XG4gICAgICB2ZWN0b3IgPSBBcnJheS5mcm9tKHZlY3Rvcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2RlY29kZXIuZmlsdGVyKHZlY3Rvcik7XG4gIH1cblxuICAvKipcbiAgICogUmFwaWRNaXggY29tcGxpYW50IGNvbmZpZ3VyYXRpb24gb2JqZWN0LlxuICAgKlxuICAgKiBAcmV0dXJuIHtPYmplY3R9IC0gUmFwaWRNaXggQ29uZmlndXJhdGlvbiBvYmplY3QuXG4gICAqL1xuICBnZXRDb25maWcoKSB7XG4gICAgcmV0dXJuIHJhcGlkTWl4QWRhcHRlcnMueG1tVG9SYXBpZE1peENvbmZpZ3VyYXRpb24oT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5fY29uZmlnLCB7XG4gICAgICBtb2RlbFR5cGU6IHRoaXMuX21vZGVsVHlwZVxuICAgIH0pKTtcbiAgICAvLyByZXR1cm4ge1xuICAgIC8vICAgZG9jVHlwZTogJ3JhcGlkLW1peDptbC1jb25maWd1cmF0aW9uJyxcbiAgICAvLyAgIGRvY1ZlcnNpb246IHJhcGlkTWl4QWRhcHRlcnMuUkFQSURfTUlYX0RPQ19WRVJTSU9OLFxuICAgIC8vICAgdGFyZ2V0OiB7XG4gICAgLy8gICAgIG5hbWU6IGB4bW06JHt0aGlzLl9tb2RlbFR5cGV9YCxcbiAgICAvLyAgICAgdmVyc2lvbjogJzEuMC4wJ1xuICAgIC8vICAgfSxcbiAgICAvLyAgIHBheWxvYWQ6IHRoaXMuX2NvbmZpZyxcbiAgICAvLyB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgbW9kZWwgY29uZmlndXJhdGlvbiBwYXJhbWV0ZXJzIChvciBhIHN1YnNldCBvZiB0aGVtKS5cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyAtIFJhcGlkTWl4IGNvbmZpZ3VyYXRpb24gb2JqZWN0IChvciBwYXlsb2FkKSwgb3Igc3Vic2V0IG9mIHBhcmFtZXRlcnMuXG4gICAqL1xuICBzZXRDb25maWcoY29uZmlnID0ge30pIHtcbiAgICBpZiAoIWNvbmZpZylcbiAgICAgIHJldHVybjtcblxuICAgIC8vIHJlcGxhY2UgbGF0ZXIgYnkgaXNWYWxpZFJhcGlkTWl4Q29uZmlndXJhdGlvbiAobW9kZWxUeXBlIHNob3VsZG4ndCBiZSBhbGxvd2VkIGluIHBheWxvYWQpXG4gICAgaWYgKGNvbmZpZy5kb2NUeXBlID09PSAncmFwaWQtbWl4Om1sLWNvbmZpZ3VyYXRpb24nICYmIGNvbmZpZy5kb2NWZXJzaW9uICYmIGNvbmZpZy5wYXlsb2FkICYmXG4gICAgICAgIGNvbmZpZy50YXJnZXQgJiYgY29uZmlnLnRhcmdldC5uYW1lICYmIGNvbmZpZy50YXJnZXQubmFtZS5zcGxpdCgnOicpWzBdID09PSAneG1tJykge1xuXG4gICAgICBjb25zdCB0YXJnZXQgPSBjb25maWcudGFyZ2V0Lm5hbWUuc3BsaXQoJzonKTtcbiAgICAgIGNvbmZpZyA9IGNvbmZpZy5wYXlsb2FkO1xuICAgICAgaWYgKHRhcmdldC5sZW5ndGggPiAxICYmIGtub3duVGFyZ2V0cy54bW0uaW5kZXhPZih0YXJnZXRbMV0pID4gLTEpIHtcbiAgICAgICAgaWYgKHRoaXMuX21vZGVsVHlwZSAhPT0gdGFyZ2V0WzFdKSB7XG4gICAgICAgICAgdGhpcy5fbW9kZWxUeXBlID0gdGFyZ2V0WzFdO1xuICAgICAgICAgIHRoaXMuX3NldERlY29kZXIoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChjb25maWcubW9kZWxUeXBlICYmIGtub3duVGFyZ2V0c1sneG1tJ10uaW5kZXhPZihjb25maWcubW9kZWxUeXBlKSA+IC0xKSB7XG4gICAgICBjb25zdCB2YWwgPSBjb25maWcubW9kZWxUeXBlO1xuICAgICAgY29uc3QgbmV3TW9kZWwgPSAodmFsID09PSAnZ21yJykgPyAnZ21tJyA6ICgodmFsID09PSAnaGhtcicpID8gJ2hobW0nIDogdmFsKTtcblxuICAgICAgaWYgKG5ld01vZGVsICE9PSB0aGlzLl9tb2RlbFR5cGUpIHtcbiAgICAgICAgdGhpcy5fbW9kZWxUeXBlID0gbmV3TW9kZWw7XG4gICAgICAgIHRoaXMuX3NldERlY29kZXIoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGxldCBrZXkgb2YgT2JqZWN0LmtleXMoY29uZmlnKSkge1xuICAgICAgY29uc3QgdmFsID0gY29uZmlnW2tleV07XG5cbiAgICAgIGlmICgoa2V5ID09PSAnZ2F1c3NpYW5zJyAmJiBOdW1iZXIuaXNJbnRlZ2VyKHZhbCkgJiYgdmFsID4gMCkgfHxcbiAgICAgICAgICAoa2V5ID09PSAnYWJzb2x1dGVSZWd1bGFyaXphdGlvbicgJiYgdHlwZW9mIHZhbCA9PT0gJ251bWJlcicgJiYgdmFsID4gMCkgfHxcbiAgICAgICAgICAoa2V5ID09PSAncmVsYXRpdmVSZWd1bGFyaXphdGlvbicgJiYgdHlwZW9mIHZhbCA9PT0gJ251bWJlcicgJiYgdmFsID4gMCkgfHxcbiAgICAgICAgICAoa2V5ID09PSAnY292YXJpYW5jZU1vZGUnICYmIHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnICYmXG4gICAgICAgICAgICBbJ2Z1bGwnLCAnZGlhZ29uYWwnXS5pbmRleE9mKHZhbCkgPiAtMSkgfHxcbiAgICAgICAgICAoa2V5ID09PSAnaGllcmFyY2hpY2FsJyAmJiB0eXBlb2YgdmFsID09PSAnYm9vbGVhbicpIHx8XG4gICAgICAgICAgKGtleSA9PT0gJ3N0YXRlcycgJiYgTnVtYmVyLmlzSW50ZWdlcih2YWwpICYmIHZhbCA+IDApIHx8XG4gICAgICAgICAgKGtleSA9PT0gJ3RyYW5zaXRpb25Nb2RlJyAmJiB0eXBlb2YgdmFsID09PSAnc3RyaW5nJyAmJlxuICAgICAgICAgICAgWydsZWZ0cmlnaHQnLCAnZXJnb2RpYyddLmluZGV4T2YodmFsKSA+IC0xKSB8fFxuICAgICAgICAgIChrZXkgPT09ICdyZWdyZXNzaW9uRXN0aW1hdG9yJyAmJiB0eXBlb2YgdmFsID09PSAnc3RyaW5nJyAmJlxuICAgICAgICAgICAgWydmdWxsJywgJ3dpbmRvd2VkJywgJ2xpa2VsaWVzdCddLmluZGV4T2YodmFsKSA+IC0xKSkge1xuICAgICAgICB0aGlzLl9jb25maWdba2V5XSA9IHZhbDtcbiAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnbGlrZWxpaG9vZFdpbmRvdycgJiYgTnVtYmVyLmlzSW50ZWdlcih2YWwpICYmIHZhbCA+IDApIHtcbiAgICAgICAgdGhpcy5fbGlrZWxpaG9vZFdpbmRvdyA9IHZhbDtcblxuICAgICAgICBpZiAodGhpcy5fZGVjb2RlciAhPT0gbnVsbCkge1xuICAgICAgICAgIHRoaXMuX2RlY29kZXIuc2V0TGlrZWxpaG9vZFdpbmRvdyh0aGlzLl9saWtlbGlob29kV2luZG93KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZSB0aGUgbW9kZWwgaW4gUmFwaWRNaXggbW9kZWwgZm9ybWF0LlxuICAgKlxuICAgKiBAcmV0dXJuIHtPYmplY3R9IC0gQ3VycmVudCBSYXBpZE1peCBNb2RlbCBvYmplY3QuXG4gICAqL1xuICBnZXRNb2RlbCgpIHtcbiAgICByZXR1cm4gdGhpcy5fbW9kZWw7XG4gIH1cblxuICAvKipcbiAgICogVXNlIHRoZSBnaXZlbiBSYXBpZE1peCBtb2RlbCBvYmplY3QgZm9yIHRoZSBkZWNvZGluZy5cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IG1vZGVsIC0gUmFwaWRNaXggTW9kZWwgb2JqZWN0LlxuICAgKi9cbiAgc2V0TW9kZWwobW9kZWwpIHtcbiAgICBpZiAoIW1vZGVsKSB7XG4gICAgICB0aGlzLm1vZGVsID0gbnVsbDtcbiAgICAgIHRoaXMuX2RlY29kZXIuc2V0TW9kZWwobnVsbCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdGFyZ2V0cyA9IG1vZGVsLnRhcmdldC5uYW1lLnNwbGl0KCc6Jyk7XG4gICAgY29uc3QgbGliID0gdGFyZ2V0c1swXTtcbiAgICBjb25zdCBhbGdvID0gdGFyZ2V0c1sxXTtcblxuICAgIGlmIChsaWIgPT09ICd4bW0nKSB7XG4gICAgICB0aGlzLl9tb2RlbFR5cGUgPSBhbGdvID09PSAnaGhtbScgPyBhbGdvIDogJ2dtbSc7XG5cbiAgICAgIHRoaXMuX3NldERlY29kZXIoKTtcbiAgICAgIHRoaXMuX21vZGVsID0gbW9kZWw7XG4gICAgICAvLyB0aGlzLl9kZWNvZGVyLnNldE1vZGVsKG1vZGVsLnBheWxvYWQpO1xuICAgICAgdGhpcy5fZGVjb2Rlci5zZXRNb2RlbChyYXBpZE1peEFkYXB0ZXJzLnJhcGlkTWl4VG9YbW1Nb2RlbChtb2RlbCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgdHlwZSAke2xpYn1gKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgWG1tUHJvY2Vzc29yO1xuIl19
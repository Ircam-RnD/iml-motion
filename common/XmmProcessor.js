'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _isFinite=require('babel-runtime/core-js/number/is-finite');var _isFinite2=_interopRequireDefault(_isFinite);var _isInteger=require('babel-runtime/core-js/number/is-integer');var _isInteger2=_interopRequireDefault(_isInteger);var _keys=require('babel-runtime/core-js/object/keys');var _keys2=_interopRequireDefault(_keys);var _getIterator2=require('babel-runtime/core-js/get-iterator');var _getIterator3=_interopRequireDefault(_getIterator2);var _assign=require('babel-runtime/core-js/object/assign');var _assign2=_interopRequireDefault(_assign);var _from=require('babel-runtime/core-js/array/from');var _from2=_interopRequireDefault(_from);var _stringify=require('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _promise=require('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _classCallCheck2=require('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _xmlhttprequest=require('xmlhttprequest');var _xmmClient=require('xmm-client');var Xmm=_interopRequireWildcard(_xmmClient);var _rapidMixAdapters=require('rapid-mix-adapters');var _rapidMixAdapters2=_interopRequireDefault(_rapidMixAdapters);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var isNode=new Function("try {return this===global;}catch(e){return false;}");var knownTargets=['gmm','gmr','hhmm','hhmr'];var defaultXmmConfig={modelType:'gmm',gaussians:1,absoluteRegularization:0.01,relativeRegularization:0.01,covarianceMode:'full',hierarchical:true,states:1,transitionMode:'leftright',regressionEstimator:'full',likelihoodWindow:10};/**
 * Representation of a gesture model. A instance of `XmmProcessor` can
 * train a model from examples and can perform classification and/or
 * regression depending on the chosen algorithm.
 *
 * The training is currently based on the presence of a remote server-side
 * API, that must be able to process rapidMix compliant JSON formats.
 *
 * @param {Object} options - Override default parameters
 * @param {String} [options.url='https://como.ircam.fr/api/v1/train'] - Url
 *  of the training end point.
 *
 * @example
 * import * as mano from 'mano-js/client';
 *
 * const processedSensors = new mano.ProcessedSensors();
 * const example = new mano.Example();
 * const trainingSet = new mano.TrainingSet();
 * const xmmProcessor = new mano.XmmProcesssor();
 *
 * example.setLabel('test');
 * processedSensors.addListener(example.addElement);
 *
 * // later
 * processedSensors.removeListener(example.addElement);
 * const rapidMixJsonExample = example.toJSON();
 *
 * trainingSet.addExample(rapidMixJsonExample);
 * const rapidMixJsonTrainingSet = trainingSet.toJSON();
 *
 * xmmProcessor
 *   .train(rapidMixJsonTrainingSet)
 *   .then(() => {
 *     // start decoding
 *     processedSensors.addListener(data => {
 *       const results = xmmProcessor.run(data);
 *       console.log(results);
 *     });
 *   });
 */var XmmProcessor=function(){function XmmProcessor(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref$url=_ref.url,url=_ref$url===undefined?'https://como.ircam.fr/api/v1/train':_ref$url;(0,_classCallCheck3.default)(this,XmmProcessor);this.url=url;this._config={};this._decoder=null;this._model=null;this._modelType=null;this._likelihoodWindow=null;this.setConfig(defaultXmmConfig);this._setDecoder();}(0,_createClass3.default)(XmmProcessor,[{key:'_setDecoder',value:function _setDecoder(){switch(this._modelType){case'hhmm':this._decoder=new Xmm.HhmmDecoder(this._likelihoodWindow);break;case'gmm':default:this._decoder=new Xmm.GmmDecoder(this._likelihoodWindow);break;}}/**
   * Reset the model's temporal decoding state. Is only valid on `hhmm` decoder.
   */},{key:'reset',value:function reset(){if(this._decoder.reset)this._decoder.reset();}/**
   * Train the model according to the given `TrainingSet`. In this implmentation
   * the training is performed server-side and rely on an XHR call.
   *
   * @param {JSON} trainingSet - RapidMix compliant JSON formatted training set
   * @return {Promise} - Promise that resolves on the API response (RapidMix API
   *  response format), when the model is updated.
   */},{key:'train',value:function train(trainingSet){var _this=this;// REST request / response - RapidMix
return new _promise2.default(function(resolve,reject){var trainingData=_rapidMixAdapters2.default.createComoHttpRequest(_this.getConfig(),trainingSet);var xhr=isNode()?new _xmlhttprequest.XMLHttpRequest():new XMLHttpRequest();xhr.open('post',_this.url,true);xhr.responseType='json';xhr.setRequestHeader('Access-Control-Allow-Origin','*');xhr.setRequestHeader('Content-Type','application/json');var errorMsg='an error occured while training the model. ';if(isNode()){// XMLHttpRequest module only supports xhr v1
xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){var body=JSON.parse(xhr.responseText);_this._model=body.payload.model;_this._decoder.setModel(_this._model.payload);resolve(body);}else{throw new Error(errorMsg+('response : '+xhr.status+' - '+xhr.responseText));}}};}else{// use xhr v2
xhr.onload=function(){if(xhr.status===200){var body=xhr.response;_this._model=body.payload.model;_this._decoder.setModel(_this._model.payload);resolve(body);}else{throw new Error(errorMsg+('response : '+xhr.status+' - '+(0,_stringify2.default)(xhr.response)));}};xhr.onerror=function(){throw new Error(errorMsg+('response : '+xhr.status+' - '+(0,_stringify2.default)(xhr.response)));};}xhr.send((0,_stringify2.default)(trainingData));});}/**
   * Perform the calssification or the regression of the given vector.
   *
   * @param {Float32Array|Array} vector - Input vector for the decoding.
   * @return {Object} results - Object containing the decoding results.
   */},{key:'run',value:function run(vector){if(vector instanceof Float32Array||vector instanceof Float64Array){vector=(0,_from2.default)(vector);}return this._decoder.filter(vector);}/**
   * RapidMix compliant configuration object.
   *
   * @return {Object} - RapidMix Configuration object.
   */},{key:'getConfig',value:function getConfig(){return _rapidMixAdapters2.default.xmmToRapidMixConfig((0,_assign2.default)({},this._config,{modelType:this._modelType}));}/**
   * Set the model configuration parameters (or a subset of them).
   *
   * @param {Object} config - RapidMix JSON configuration object or subset of parameters.
   */},{key:'setConfig',value:function setConfig(){var config=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!config)return;if(config.docType==='rapid-mix:ml-configuration'&&config.docVersion&&config.payload&&config.target&&config.target.name==='xmm'){config=config.payload;}if(config.modelType&&knownTargets.indexOf(config.modelType)>-1){var modelType=config.modelType;var newModelType=null;switch(modelType){case'gmm':case'gmr':newModelType='gmm';break;case'hhmm':case'hhmr':newModelType='hhmm';break;}if(newModelType!==this._modelType){this._modelType=newModelType;this._setDecoder();}}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=(0,_getIterator3.default)((0,_keys2.default)(config)),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var key=_step.value;var val=config[key];if(key==='gaussians'&&(0,_isInteger2.default)(val)&&val>0||key==='absoluteRegularization'&&(0,_isFinite2.default)(val)&&val>0||key==='relativeRegularization'&&(0,_isFinite2.default)(val)&&val>0||key==='covarianceMode'&&['full','diagonal'].indexOf(val)>-1||key==='hierarchical'&&typeof val==='boolean'||key==='states'&&(0,_isInteger2.default)(val)&&val>0||key==='transitionMode'&&['leftright','ergodic'].indexOf(val)>-1||key==='regressionEstimator'&&['full','windowed','likeliest'].indexOf(val)>-1||key==='multiClassRegressionEstimator'&&['likeliest','mixture'].indexOf(val)>-1){this._config[key]=val;}else if(key==='likelihoodWindow'&&(0,_isInteger2.default)(val)&&val>0){this._likelihoodWindow=val;if(this._decoder!==null){this._decoder.setLikelihoodWindow(this._likelihoodWindow);}}}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}}/**
   * Retrieve the model in RapidMix model format.
   *
   * @return {Object} - Current RapidMix Model object.
   */},{key:'getModel',value:function getModel(){return this._model;}/**
   * Use the given RapidMix model object for the decoding.
   *
   * @param {Object} model - RapidMix Model object.
   */},{key:'setModel',value:function setModel(model){if(!model){this.model=null;this._decoder.setModel(null);return;}if(model.target.name==='xmm'){this._modelType=model.payload.modelType;this._model=model;var xmmModel=_rapidMixAdapters2.default.rapidMixToXmmModel(model);this._setDecoder();this._decoder.setModel(xmmModel);}else{throw new Error('Invalid target name');}}}]);return XmmProcessor;}();exports.default=XmmProcessor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIlhtbSIsImlzTm9kZSIsIkZ1bmN0aW9uIiwia25vd25UYXJnZXRzIiwiZGVmYXVsdFhtbUNvbmZpZyIsIm1vZGVsVHlwZSIsImdhdXNzaWFucyIsImFic29sdXRlUmVndWxhcml6YXRpb24iLCJyZWxhdGl2ZVJlZ3VsYXJpemF0aW9uIiwiY292YXJpYW5jZU1vZGUiLCJoaWVyYXJjaGljYWwiLCJzdGF0ZXMiLCJ0cmFuc2l0aW9uTW9kZSIsInJlZ3Jlc3Npb25Fc3RpbWF0b3IiLCJsaWtlbGlob29kV2luZG93IiwiWG1tUHJvY2Vzc29yIiwidXJsIiwiX2NvbmZpZyIsIl9kZWNvZGVyIiwiX21vZGVsIiwiX21vZGVsVHlwZSIsIl9saWtlbGlob29kV2luZG93Iiwic2V0Q29uZmlnIiwiX3NldERlY29kZXIiLCJIaG1tRGVjb2RlciIsIkdtbURlY29kZXIiLCJyZXNldCIsInRyYWluaW5nU2V0IiwicmVzb2x2ZSIsInJlamVjdCIsInRyYWluaW5nRGF0YSIsImNyZWF0ZUNvbW9IdHRwUmVxdWVzdCIsImdldENvbmZpZyIsInhociIsIlhNTEh0dHBSZXF1ZXN0Iiwib3BlbiIsInJlc3BvbnNlVHlwZSIsInNldFJlcXVlc3RIZWFkZXIiLCJlcnJvck1zZyIsIm9ucmVhZHlzdGF0ZWNoYW5nZSIsInJlYWR5U3RhdGUiLCJzdGF0dXMiLCJib2R5IiwiSlNPTiIsInBhcnNlIiwicmVzcG9uc2VUZXh0IiwicGF5bG9hZCIsIm1vZGVsIiwic2V0TW9kZWwiLCJFcnJvciIsIm9ubG9hZCIsInJlc3BvbnNlIiwib25lcnJvciIsInNlbmQiLCJ2ZWN0b3IiLCJGbG9hdDMyQXJyYXkiLCJGbG9hdDY0QXJyYXkiLCJmaWx0ZXIiLCJ4bW1Ub1JhcGlkTWl4Q29uZmlnIiwiY29uZmlnIiwiZG9jVHlwZSIsImRvY1ZlcnNpb24iLCJ0YXJnZXQiLCJuYW1lIiwiaW5kZXhPZiIsIm5ld01vZGVsVHlwZSIsImtleSIsInZhbCIsInNldExpa2Vs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LENBQWFDLElBQWIsR0FBc0IsS0FBMUIsQ0FBaUMsQ0FDL0IsS0FBSzNDLFVBQUwsQ0FBa0IyQixNQUFNRCxPQUFOLENBQWN6QyxTQUFoQyxDQUNBLEtBQUtjLE1BQUwsQ0FBYzRCLEtBQWQsQ0FDQSxHQUFNc0IsVUFBVywyQkFBaUJDLGtCQUFqQixDQUFvQ3ZCLEtBQXBDLENBQWpCLENBRUEsS0FBS3hCLFdBQUwsR0FDQSxLQUFLTCxRQUFMLENBQWM4QixRQUFkLENBQXVCcUIsUUFBdkIsRUFDRCxDQVBELElBT08sQ0FDTCxLQUFNLElBQUlwQixNQUFKLHVCQUFOLENBQ0QsQ0FDRixDLDRDQUdZbEMsWSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFhNTEh0dHBSZXF1ZXN0IGFzIFhIUiB9IGZyb20gJ3htbGh0dHByZXF1ZXN0JztcbmltcG9ydCAqIGFzIFhtbSBmcm9tICd4bW0tY2xpZW50JztcbmltcG9ydCByYXBpZE1peEFkYXB0ZXJzIGZyb20gJ3JhcGlkLW1peC1hZGFwdGVycyc7XG5cbmNvbnN0IGlzTm9kZSA9IG5ldyBGdW5jdGlvbihcInRyeSB7cmV0dXJuIHRoaXM9PT1nbG9iYWw7fWNhdGNoKGUpe3JldHVybiBmYWxzZTt9XCIpO1xuXG5jb25zdCBrbm93blRhcmdldHMgPSBbICdnbW0nLCAnZ21yJywgJ2hobW0nLCAnaGhtcicgXTtcblxuY29uc3QgZGVmYXVsdFhtbUNvbmZpZyA9IHtcbiAgbW9kZWxUeXBlOiAnZ21tJyxcbiAgZ2F1c3NpYW5zOiAxLFxuICBhYnNvbHV0ZVJlZ3VsYXJpemF0aW9uOiAwLjAxLFxuICByZWxhdGl2ZVJlZ3VsYXJpemF0aW9uOiAwLjAxLFxuICBjb3ZhcmlhbmNlTW9kZTogJ2Z1bGwnLFxuICBoaWVyYXJjaGljYWw6IHRydWUsXG4gIHN0YXRlczogMSxcbiAgdHJhbnNpdGlvbk1vZGU6ICdsZWZ0cmlnaHQnLFxuICByZWdyZXNzaW9uRXN0aW1hdG9yOiAnZnVsbCcsXG4gIGxpa2VsaWhvb2RXaW5kb3c6IDEwLFxufTtcblxuLyoqXG4gKiBSZXByZXNlbnRhdGlvbiBvZiBhIGdlc3R1cmUgbW9kZWwuIEEgaW5zdGFuY2Ugb2YgYFhtbVByb2Nlc3NvcmAgY2FuXG4gKiB0cmFpbiBhIG1vZGVsIGZyb20gZXhhbXBsZXMgYW5kIGNhbiBwZXJmb3JtIGNsYXNzaWZpY2F0aW9uIGFuZC9vclxuICogcmVncmVzc2lvbiBkZXBlbmRpbmcgb24gdGhlIGNob3NlbiBhbGdvcml0aG0uXG4gKlxuICogVGhlIHRyYWluaW5nIGlzIGN1cnJlbnRseSBiYXNlZCBvbiB0aGUgcHJlc2VuY2Ugb2YgYSByZW1vdGUgc2VydmVyLXNpZGVcbiAqIEFQSSwgdGhhdCBtdXN0IGJlIGFibGUgdG8gcHJvY2VzcyByYXBpZE1peCBjb21wbGlhbnQgSlNPTiBmb3JtYXRzLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gT3ZlcnJpZGUgZGVmYXVsdCBwYXJhbWV0ZXJzXG4gKiBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMudXJsPSdodHRwczovL2NvbW8uaXJjYW0uZnIvYXBpL3YxL3RyYWluJ10gLSBVcmxcbiAqICBvZiB0aGUgdHJhaW5pbmcgZW5kIHBvaW50LlxuICpcbiAqIEBleGFtcGxlXG4gKiBpbXBvcnQgKiBhcyBtYW5vIGZyb20gJ21hbm8tanMvY2xpZW50JztcbiAqXG4gKiBjb25zdCBwcm9jZXNzZWRTZW5zb3JzID0gbmV3IG1hbm8uUHJvY2Vzc2VkU2Vuc29ycygpO1xuICogY29uc3QgZXhhbXBsZSA9IG5ldyBtYW5vLkV4YW1wbGUoKTtcbiAqIGNvbnN0IHRyYWluaW5nU2V0ID0gbmV3IG1hbm8uVHJhaW5pbmdTZXQoKTtcbiAqIGNvbnN0IHhtbVByb2Nlc3NvciA9IG5ldyBtYW5vLlhtbVByb2Nlc3Nzb3IoKTtcbiAqXG4gKiBleGFtcGxlLnNldExhYmVsKCd0ZXN0Jyk7XG4gKiBwcm9jZXNzZWRTZW5zb3JzLmFkZExpc3RlbmVyKGV4YW1wbGUuYWRkRWxlbWVudCk7XG4gKlxuICogLy8gbGF0ZXJcbiAqIHByb2Nlc3NlZFNlbnNvcnMucmVtb3ZlTGlzdGVuZXIoZXhhbXBsZS5hZGRFbGVtZW50KTtcbiAqIGNvbnN0IHJhcGlkTWl4SnNvbkV4YW1wbGUgPSBleGFtcGxlLnRvSlNPTigpO1xuICpcbiAqIHRyYWluaW5nU2V0LmFkZEV4YW1wbGUocmFwaWRNaXhKc29uRXhhbXBsZSk7XG4gKiBjb25zdCByYXBpZE1peEpzb25UcmFpbmluZ1NldCA9IHRyYWluaW5nU2V0LnRvSlNPTigpO1xuICpcbiAqIHhtbVByb2Nlc3NvclxuICogICAudHJhaW4ocmFwaWRNaXhKc29uVHJhaW5pbmdTZXQpXG4gKiAgIC50aGVuKCgpID0+IHtcbiAqICAgICAvLyBzdGFydCBkZWNvZGluZ1xuICogICAgIHByb2Nlc3NlZFNlbnNvcnMuYWRkTGlzdGVuZXIoZGF0YSA9PiB7XG4gKiAgICAgICBjb25zdCByZXN1bHRzID0geG1tUHJvY2Vzc29yLnJ1bihkYXRhKTtcbiAqICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdHMpO1xuICogICAgIH0pO1xuICogICB9KTtcbiAqL1xuY2xhc3MgWG1tUHJvY2Vzc29yIHtcbiAgY29uc3RydWN0b3Ioe1xuICAgIHVybCA9ICdodHRwczovL2NvbW8uaXJjYW0uZnIvYXBpL3YxL3RyYWluJyxcbiAgfSA9IHt9KSB7XG4gICAgdGhpcy51cmwgPSB1cmw7XG5cbiAgICB0aGlzLl9jb25maWcgPSB7fTtcbiAgICB0aGlzLl9kZWNvZGVyID0gbnVsbDtcbiAgICB0aGlzLl9tb2RlbCA9IG51bGw7XG4gICAgdGhpcy5fbW9kZWxUeXBlID0gbnVsbDtcbiAgICB0aGlzLl9saWtlbGlob29kV2luZG93ID0gbnVsbDtcblxuICAgIHRoaXMuc2V0Q29uZmlnKGRlZmF1bHRYbW1Db25maWcpO1xuICAgIHRoaXMuX3NldERlY29kZXIoKTtcbiAgfVxuXG4gIF9zZXREZWNvZGVyKCkge1xuICAgIHN3aXRjaCAodGhpcy5fbW9kZWxUeXBlKSB7XG4gICAgICBjYXNlICdoaG1tJzpcbiAgICAgICAgdGhpcy5fZGVjb2RlciA9IG5ldyBYbW0uSGhtbURlY29kZXIodGhpcy5fbGlrZWxpaG9vZFdpbmRvdyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnZ21tJzpcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMuX2RlY29kZXIgPSBuZXcgWG1tLkdtbURlY29kZXIodGhpcy5fbGlrZWxpaG9vZFdpbmRvdyk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldCB0aGUgbW9kZWwncyB0ZW1wb3JhbCBkZWNvZGluZyBzdGF0ZS4gSXMgb25seSB2YWxpZCBvbiBgaGhtbWAgZGVjb2Rlci5cbiAgICovXG4gIHJlc2V0KCkge1xuICAgIGlmICh0aGlzLl9kZWNvZGVyLnJlc2V0KVxuICAgICAgdGhpcy5fZGVjb2Rlci5yZXNldCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYWluIHRoZSBtb2RlbCBhY2NvcmRpbmcgdG8gdGhlIGdpdmVuIGBUcmFpbmluZ1NldGAuIEluIHRoaXMgaW1wbG1lbnRhdGlvblxuICAgKiB0aGUgdHJhaW5pbmcgaXMgcGVyZm9ybWVkIHNlcnZlci1zaWRlIGFuZCByZWx5IG9uIGFuIFhIUiBjYWxsLlxuICAgKlxuICAgKiBAcGFyYW0ge0pTT059IHRyYWluaW5nU2V0IC0gUmFwaWRNaXggY29tcGxpYW50IEpTT04gZm9ybWF0dGVkIHRyYWluaW5nIHNldFxuICAgKiBAcmV0dXJuIHtQcm9taXNlfSAtIFByb21pc2UgdGhhdCByZXNvbHZlcyBvbiB0aGUgQVBJIHJlc3BvbnNlIChSYXBpZE1peCBBUElcbiAgICogIHJlc3BvbnNlIGZvcm1hdCksIHdoZW4gdGhlIG1vZGVsIGlzIHVwZGF0ZWQuXG4gICAqL1xuICB0cmFpbih0cmFpbmluZ1NldCkge1xuICAgIC8vIFJFU1QgcmVxdWVzdCAvIHJlc3BvbnNlIC0gUmFwaWRNaXhcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgdHJhaW5pbmdEYXRhID0gcmFwaWRNaXhBZGFwdGVycy5jcmVhdGVDb21vSHR0cFJlcXVlc3QodGhpcy5nZXRDb25maWcoKSwgdHJhaW5pbmdTZXQpO1xuXG4gICAgICBjb25zdCB4aHIgPSBpc05vZGUoKSA/IG5ldyBYSFIoKSA6IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuXG4gICAgICB4aHIub3BlbigncG9zdCcsIHRoaXMudXJsLCB0cnVlKTtcbiAgICAgIHhoci5yZXNwb25zZVR5cGUgPSAnanNvbic7XG4gICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcbiAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuXG4gICAgICBjb25zdCBlcnJvck1zZyA9ICdhbiBlcnJvciBvY2N1cmVkIHdoaWxlIHRyYWluaW5nIHRoZSBtb2RlbC4gJztcblxuICAgICAgaWYgKGlzTm9kZSgpKSB7IC8vIFhNTEh0dHBSZXF1ZXN0IG1vZHVsZSBvbmx5IHN1cHBvcnRzIHhociB2MVxuICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gKCkgPT4ge1xuICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PT0gNCkge1xuICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgICAgdGhpcy5fbW9kZWwgPSBib2R5LnBheWxvYWQubW9kZWw7XG4gICAgICAgICAgICAgIHRoaXMuX2RlY29kZXIuc2V0TW9kZWwodGhpcy5fbW9kZWwucGF5bG9hZCk7XG4gICAgICAgICAgICAgIHJlc29sdmUoYm9keSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cgKyBgcmVzcG9uc2UgOiAke3hoci5zdGF0dXN9IC0gJHt4aHIucmVzcG9uc2VUZXh0fWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHsgLy8gdXNlIHhociB2MlxuICAgICAgICB4aHIub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgIGNvbnN0IGJvZHkgPSB4aHIucmVzcG9uc2U7XG4gICAgICAgICAgICB0aGlzLl9tb2RlbCA9IGJvZHkucGF5bG9hZC5tb2RlbDtcbiAgICAgICAgICAgIHRoaXMuX2RlY29kZXIuc2V0TW9kZWwodGhpcy5fbW9kZWwucGF5bG9hZCk7XG4gICAgICAgICAgICByZXNvbHZlKGJvZHkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cgKyBgcmVzcG9uc2UgOiAke3hoci5zdGF0dXN9IC0gJHtKU09OLnN0cmluZ2lmeSh4aHIucmVzcG9uc2UpfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB4aHIub25lcnJvciA9ICgpID0+IHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cgKyBgcmVzcG9uc2UgOiAke3hoci5zdGF0dXN9IC0gJHtKU09OLnN0cmluZ2lmeSh4aHIucmVzcG9uc2UpfWApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHhoci5zZW5kKEpTT04uc3RyaW5naWZ5KHRyYWluaW5nRGF0YSkpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gdGhlIGNhbHNzaWZpY2F0aW9uIG9yIHRoZSByZWdyZXNzaW9uIG9mIHRoZSBnaXZlbiB2ZWN0b3IuXG4gICAqXG4gICAqIEBwYXJhbSB7RmxvYXQzMkFycmF5fEFycmF5fSB2ZWN0b3IgLSBJbnB1dCB2ZWN0b3IgZm9yIHRoZSBkZWNvZGluZy5cbiAgICogQHJldHVybiB7T2JqZWN0fSByZXN1bHRzIC0gT2JqZWN0IGNvbnRhaW5pbmcgdGhlIGRlY29kaW5nIHJlc3VsdHMuXG4gICAqL1xuICBydW4odmVjdG9yKSB7XG4gICAgaWYgKHZlY3RvciBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSB8fCB2ZWN0b3IgaW5zdGFuY2VvZiBGbG9hdDY0QXJyYXkpIHtcbiAgICAgIHZlY3RvciA9IEFycmF5LmZyb20odmVjdG9yKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fZGVjb2Rlci5maWx0ZXIodmVjdG9yKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSYXBpZE1peCBjb21wbGlhbnQgY29uZmlndXJhdGlvbiBvYmplY3QuXG4gICAqXG4gICAqIEByZXR1cm4ge09iamVjdH0gLSBSYXBpZE1peCBDb25maWd1cmF0aW9uIG9iamVjdC5cbiAgICovXG4gIGdldENvbmZpZygpIHtcbiAgICByZXR1cm4gcmFwaWRNaXhBZGFwdGVycy54bW1Ub1JhcGlkTWl4Q29uZmlnKE9iamVjdC5hc3NpZ24oe30sIHRoaXMuX2NvbmZpZywge1xuICAgICAgbW9kZWxUeXBlOiB0aGlzLl9tb2RlbFR5cGVcbiAgICB9KSk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBtb2RlbCBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMgKG9yIGEgc3Vic2V0IG9mIHRoZW0pLlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIC0gUmFwaWRNaXggSlNPTiBjb25maWd1cmF0aW9uIG9iamVjdCBvciBzdWJzZXQgb2YgcGFyYW1ldGVycy5cbiAgICovXG4gIHNldENvbmZpZyhjb25maWcgPSB7fSkge1xuICAgIGlmICghY29uZmlnKVxuICAgICAgcmV0dXJuO1xuXG4gICAgaWYgKGNvbmZpZy5kb2NUeXBlID09PSAncmFwaWQtbWl4Om1sLWNvbmZpZ3VyYXRpb24nICYmXG4gICAgICAgIGNvbmZpZy5kb2NWZXJzaW9uICYmXG4gICAgICAgIGNvbmZpZy5wYXlsb2FkICYmXG4gICAgICAgIGNvbmZpZy50YXJnZXQgJiZcbiAgICAgICAgY29uZmlnLnRhcmdldC5uYW1lID09PSAneG1tJ1xuICAgICkge1xuICAgICAgY29uZmlnID0gY29uZmlnLnBheWxvYWQ7XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy5tb2RlbFR5cGUgJiYga25vd25UYXJnZXRzLmluZGV4T2YoY29uZmlnLm1vZGVsVHlwZSkgPiAtMSkge1xuICAgICAgY29uc3QgbW9kZWxUeXBlID0gY29uZmlnLm1vZGVsVHlwZTtcbiAgICAgIGxldCBuZXdNb2RlbFR5cGUgPSBudWxsO1xuXG4gICAgICBzd2l0Y2ggKG1vZGVsVHlwZSkge1xuICAgICAgICBjYXNlICdnbW0nOlxuICAgICAgICBjYXNlICdnbXInOlxuICAgICAgICAgIG5ld01vZGVsVHlwZSA9ICdnbW0nO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdoaG1tJzpcbiAgICAgICAgY2FzZSAnaGhtcic6XG4gICAgICAgICAgbmV3TW9kZWxUeXBlID0gJ2hobW0nO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBpZiAobmV3TW9kZWxUeXBlICE9PSB0aGlzLl9tb2RlbFR5cGUpIHtcbiAgICAgICAgdGhpcy5fbW9kZWxUeXBlID0gbmV3TW9kZWxUeXBlO1xuICAgICAgICB0aGlzLl9zZXREZWNvZGVyKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChsZXQga2V5IG9mIE9iamVjdC5rZXlzKGNvbmZpZykpIHtcbiAgICAgIGNvbnN0IHZhbCA9IGNvbmZpZ1trZXldO1xuXG4gICAgICBpZiAoKGtleSA9PT0gJ2dhdXNzaWFucycgJiYgTnVtYmVyLmlzSW50ZWdlcih2YWwpICYmIHZhbCA+IDApIHx8XG4gICAgICAgICAgKGtleSA9PT0gJ2Fic29sdXRlUmVndWxhcml6YXRpb24nICYmIE51bWJlci5pc0Zpbml0ZSh2YWwpICYmIHZhbCA+IDApIHx8XG4gICAgICAgICAgKGtleSA9PT0gJ3JlbGF0aXZlUmVndWxhcml6YXRpb24nICYmIE51bWJlci5pc0Zpbml0ZSh2YWwpICYmIHZhbCA+IDApIHx8XG4gICAgICAgICAgKGtleSA9PT0gJ2NvdmFyaWFuY2VNb2RlJyAmJiBbJ2Z1bGwnLCAnZGlhZ29uYWwnXS5pbmRleE9mKHZhbCkgPiAtMSkgfHxcbiAgICAgICAgICAoa2V5ID09PSAnaGllcmFyY2hpY2FsJyAmJiB0eXBlb2YgdmFsID09PSAnYm9vbGVhbicpIHx8XG4gICAgICAgICAgKGtleSA9PT0gJ3N0YXRlcycgJiYgTnVtYmVyLmlzSW50ZWdlcih2YWwpICYmIHZhbCA+IDApIHx8XG4gICAgICAgICAgKGtleSA9PT0gJ3RyYW5zaXRpb25Nb2RlJyAmJiBbJ2xlZnRyaWdodCcsICdlcmdvZGljJ10uaW5kZXhPZih2YWwpID4gLTEpIHx8XG4gICAgICAgICAgKGtleSA9PT0gJ3JlZ3Jlc3Npb25Fc3RpbWF0b3InICYmIFsnZnVsbCcsICd3aW5kb3dlZCcsICdsaWtlbGllc3QnXS5pbmRleE9mKHZhbCkgPiAtMSkgfHxcbiAgICAgICAgICAoa2V5ID09PSAnbXVsdGlDbGFzc1JlZ3Jlc3Npb25Fc3RpbWF0b3InICYmIFsnbGlrZWxpZXN0JywgJ21peHR1cmUnXS5pbmRleE9mKHZhbCkgPiAtMSkpIHtcbiAgICAgICAgdGhpcy5fY29uZmlnW2tleV0gPSB2YWw7XG4gICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ2xpa2VsaWhvb2RXaW5kb3cnICYmIE51bWJlci5pc0ludGVnZXIodmFsKSAmJiB2YWwgPiAwKSB7XG4gICAgICAgIHRoaXMuX2xpa2VsaWhvb2RXaW5kb3cgPSB2YWw7XG5cbiAgICAgICAgaWYgKHRoaXMuX2RlY29kZXIgIT09IG51bGwpIHtcbiAgICAgICAgICB0aGlzLl9kZWNvZGVyLnNldExpa2VsaWhvb2RXaW5kb3codGhpcy5fbGlrZWxpaG9vZFdpbmRvdyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZSB0aGUgbW9kZWwgaW4gUmFwaWRNaXggbW9kZWwgZm9ybWF0LlxuICAgKlxuICAgKiBAcmV0dXJuIHtPYmplY3R9IC0gQ3VycmVudCBSYXBpZE1peCBNb2RlbCBvYmplY3QuXG4gICAqL1xuICBnZXRNb2RlbCgpIHtcbiAgICByZXR1cm4gdGhpcy5fbW9kZWw7XG4gIH1cblxuICAvKipcbiAgICogVXNlIHRoZSBnaXZlbiBSYXBpZE1peCBtb2RlbCBvYmplY3QgZm9yIHRoZSBkZWNvZGluZy5cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IG1vZGVsIC0gUmFwaWRNaXggTW9kZWwgb2JqZWN0LlxuICAgKi9cbiAgc2V0TW9kZWwobW9kZWwpIHtcbiAgICBpZiAoIW1vZGVsKSB7XG4gICAgICB0aGlzLm1vZGVsID0gbnVsbDtcbiAgICAgIHRoaXMuX2RlY29kZXIuc2V0TW9kZWwobnVsbCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKG1vZGVsLnRhcmdldC5uYW1lID09PSAneG1tJykge1xuICAgICAgdGhpcy5fbW9kZWxUeXBlID0gbW9kZWwucGF5bG9hZC5tb2RlbFR5cGU7XG4gICAgICB0aGlzLl9tb2RlbCA9IG1vZGVsO1xuICAgICAgY29uc3QgeG1tTW9kZWwgPSByYXBpZE1peEFkYXB0ZXJzLnJhcGlkTWl4VG9YbW1Nb2RlbChtb2RlbCk7XG5cbiAgICAgIHRoaXMuX3NldERlY29kZXIoKTtcbiAgICAgIHRoaXMuX2RlY29kZXIuc2V0TW9kZWwoeG1tTW9kZWwpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgdGFyZ2V0IG5hbWVgKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgWG1tUHJvY2Vzc29yO1xuIl19
'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _isInteger=require('babel-runtime/core-js/number/is-integer');var _isInteger2=_interopRequireDefault(_isInteger);var _keys=require('babel-runtime/core-js/object/keys');var _keys2=_interopRequireDefault(_keys);var _getIterator2=require('babel-runtime/core-js/get-iterator');var _getIterator3=_interopRequireDefault(_getIterator2);var _assign=require('babel-runtime/core-js/object/assign');var _assign2=_interopRequireDefault(_assign);var _from=require('babel-runtime/core-js/array/from');var _from2=_interopRequireDefault(_from);var _stringify=require('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _promise=require('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _classCallCheck2=require('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _xmlhttprequest=require('xmlhttprequest');var _xmmClient=require('xmm-client');var Xmm=_interopRequireWildcard(_xmmClient);var _rapidMixAdapters=require('rapid-mix-adapters');var _rapidMixAdapters2=_interopRequireDefault(_rapidMixAdapters);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var isNode=new Function("try {return this===global;}catch(e){return false;}");var knownTargets={xmm:['gmm','gmr','hhmm','hhmr']};var defaultXmmConfig={modelType:'gmm',gaussians:1,absoluteRegularization:0.01,relativeRegularization:0.01,covarianceMode:'full',hierarchical:true,states:1,transitionMode:'leftright',regressionEstimator:'full',likelihoodWindow:10};/**
 * Representation of a gesture model. A instance of `XmmProcessor` can
 * train a model from examples and can perform classification and/or
 * regression depending on the chosen algorithm.
 *
 * The training is currently based on the presence of a remote server-side
 * API, that must be able to process rapidMix compliant JSON formats.
 *
 * @param {Object} options - Override default parameters
 * @param {String} [options.url='https://como.ircam.fr/api/v1/train'] - Url
 *  of the training end point.
 *
 * @example
 * import * as mano from 'mano-js/client';
 *
 * const processedSensors = new mano.ProcessedSensors();
 * const example = new mano.Example();
 * const trainingSet = new mano.TrainingSet();
 * const xmmProcessor = new mano.XmmProcesssor();
 *
 * example.setLabel('test');
 * processedSensors.addListener(example.addElement);
 *
 * // later
 * processedSensors.removeListener(example.addElement);
 * const rapidMixJsonExample = example.toJSON();
 *
 * trainingSet.addExample(rapidMixJsonExample);
 * const rapidMixJsonTrainingSet = trainingSet.toJSON();
 *
 * xmmProcessor
 *   .train(rapidMixJsonTrainingSet)
 *   .then(() => {
 *     // start decoding
 *     processedSensors.addListener(data => {
 *       const results = xmmProcessor.run(data);
 *       console.log(results);
 *     });
 *   });
 */var XmmProcessor=function(){function XmmProcessor(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref$url=_ref.url,url=_ref$url===undefined?'https://como.ircam.fr/api/v1/train':_ref$url;(0,_classCallCheck3.default)(this,XmmProcessor);this.url=url;this._config={};this._decoder=null;this._model=null;this._modelType=null;this._likelihoodWindow=null;this.setConfig(defaultXmmConfig);this._setDecoder();}(0,_createClass3.default)(XmmProcessor,[{key:'_setDecoder',value:function _setDecoder(){switch(this._modelType){case'hhmm':this._decoder=new Xmm.HhmmDecoder(this._likelihoodWindow);break;case'gmm':default:this._decoder=new Xmm.GmmDecoder(this._likelihoodWindow);break;}}/**
   * Reset the model's temporal decoding state. Is only valid on `hhmm` decoder.
   */},{key:'reset',value:function reset(){if(this._decoder.reset)this._decoder.reset();}/**
   * Train the model according to the given `TrainingSet`. In this implmentation
   * the training is performed server-side and rely on an XHR call.
   *
   * @param {JSON} trainingSet - RapidMix compliant JSON formatted training set
   * @return {Promise} - Promise that resolves on the API response (RapidMix API
   *  response format), when the model is updated.
   */},{key:'train',value:function train(trainingSet){var _this=this;// REST request / response - RapidMix
return new _promise2.default(function(resolve,reject){var trainingData=_rapidMixAdapters2.default.createComoHttpRequest(_this.getConfig(),trainingSet);console.log(trainingData);var xhr=isNode()?new _xmlhttprequest.XMLHttpRequest():new XMLHttpRequest();xhr.open('post',_this.url,true);xhr.responseType='json';xhr.setRequestHeader('Access-Control-Allow-Origin','*');xhr.setRequestHeader('Content-Type','application/json');var errorMsg='an error occured while training the model. ';if(isNode()){// XMLHttpRequest module only supports xhr v1
xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){var body=JSON.parse(xhr.responseText);_this._model=body.payload.model;_this._decoder.setModel(_this._model.payload);resolve(body);}else{throw new Error(errorMsg+('response : '+xhr.status+' - '+xhr.responseText));}}};}else{// use xhr v2
xhr.onload=function(){if(xhr.status===200){var body=xhr.response;_this._model=body.payload.model;_this._decoder.setModel(_this._model.payload);resolve(body);}else{throw new Error(errorMsg+('response : '+xhr.status+' - '+xhr.response));}};xhr.onerror=function(){throw new Error(errorMsg+('response : '+xhr.status+' - '+xhr.response));};}xhr.send((0,_stringify2.default)(trainingData));});}/**
   * Perform the calssification or the regression of the given vector.
   *
   * @param {Float32Array|Array} vector - Input vector for the decoding.
   * @return {Object} results - Object containing the decoding results.
   */},{key:'run',value:function run(vector){if(vector instanceof Float32Array||vector instanceof Float64Array){vector=(0,_from2.default)(vector);}return this._decoder.filter(vector);}/**
   * RapidMix compliant configuration object.
   *
   * @return {Object} - RapidMix Configuration object.
   */},{key:'getConfig',value:function getConfig(){return _rapidMixAdapters2.default.xmmToRapidMixConfig((0,_assign2.default)({},this._config,{modelType:this._modelType}));// return {
//   docType: 'rapid-mix:ml-configuration',
//   docVersion: rapidMixAdapters.RAPID_MIX_DOC_VERSION,
//   target: {
//     name: `xmm:${this._modelType}`,
//     version: '1.0.0'
//   },
//   payload: this._config,
// };
}/**
   * Set the model configuration parameters (or a subset of them).
   *
   * @param {Object} config - RapidMix configuration object (or payload), or subset of parameters.
   */},{key:'setConfig',value:function setConfig(){var config=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!config)return;// replace later by isValidRapidMixConfiguration (modelType shouldn't be allowed in payload)
if(config.docType==='rapid-mix:ml-configuration'&&config.docVersion&&config.payload&&config.target&&config.target.name&&config.target.name.split(':')[0]==='xmm'){var target=config.target.name.split(':');config=config.payload;if(target.length>1&&knownTargets.xmm.indexOf(target[1])>-1){if(this._modelType!==target[1]){this._modelType=target[1];this._setDecoder();}}}if(config.modelType&&knownTargets['xmm'].indexOf(config.modelType)>-1){var val=config.modelType;var newModel=val==='gmr'?'gmm':val==='hhmr'?'hhmm':val;if(newModel!==this._modelType){this._modelType=newModel;this._setDecoder();}}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=(0,_getIterator3.default)((0,_keys2.default)(config)),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var key=_step.value;var _val=config[key];if(key==='gaussians'&&(0,_isInteger2.default)(_val)&&_val>0||key==='absoluteRegularization'&&typeof _val==='number'&&_val>0||key==='relativeRegularization'&&typeof _val==='number'&&_val>0||key==='covarianceMode'&&typeof _val==='string'&&['full','diagonal'].indexOf(_val)>-1||key==='hierarchical'&&typeof _val==='boolean'||key==='states'&&(0,_isInteger2.default)(_val)&&_val>0||key==='transitionMode'&&typeof _val==='string'&&['leftright','ergodic'].indexOf(_val)>-1||key==='regressionEstimator'&&typeof _val==='string'&&['full','windowed','likeliest'].indexOf(_val)>-1){this._config[key]=_val;}else if(key==='likelihoodWindow'&&(0,_isInteger2.default)(_val)&&_val>0){this._likelihoodWindow=_val;if(this._decoder!==null){this._decoder.setLikelihoodWindow(this._likelihoodWindow);}}}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}}/**
   * Retrieve the model in RapidMix model format.
   *
   * @return {Object} - Current RapidMix Model object.
   */},{key:'getModel',value:function getModel(){return this._model;}/**
   * Use the given RapidMix model object for the decoding.
   *
   * @param {Object} model - RapidMix Model object.
   */},{key:'setModel',value:function setModel(model){if(!model){this.model=null;this._decoder.setModel(null);return;}var targets=model.target.name.split(':');var lib=targets[0];var algo=targets[1];if(lib==='xmm'){this._modelType=algo==='hhmm'?algo:'gmm';this._setDecoder();this._model=model;// this._decoder.setModel(model.payload);
this._decoder.setModel(_rapidMixAdapters2.default.rapidMixToXmmModel(model));}else{throw new Error('Invalid type '+lib);}}}]);return XmmProcessor;}();exports.default=XmmProcessor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIlhtbSIsImlzTm9kZSIsIkZ1bmN0aW9uIiwia25vd25UYXJnZXRzIiwieG1tIiwiZGVmYXVsdFhtbUNvbmZpZyIsIm1vZGVsVHlwZSIsImdhdXNzaWFucyIsImFic29sdXRlUmVndWxhcml6YXRpb24iLCJyZWxhdGl2ZVJlZ3VsYXJpemF0aW9uIiwiY292YXJpYW5jZU1vZGUiLCJoaWVyYXJjaGljYWwiLCJzdGF0ZXMiLCJ0cmFuc2l0aW9uTW9kZSIsInJlZ3Jlc3Npb25Fc3RpbWF0b3IiLCJsaWtlbGlob29kV2luZG93IiwiWG1tUHJvY2Vzc29yIiwidXJsIiwiX2NvbmZpZyIsIl9kZWNvZGVyIiwiX21vZGVsIiwiX21vZGVsVHlwZSIsIl9saWtlbGlob29kV2luZG93Iiwic2V0Q29uZmlnIiwiX3NldERlY29kZXIiLCJIaG1tRGVjb2RlciIsIkdtbURlY29kZXIiLCJyZXNldCIsInRyYWluaW5nU2V0IiwicmVzb2x2ZSIsInJlamVjdCIsInRyYWluaW5nRGF0YSIsImNyZWF0ZUNvbW9IdHRwUmVxdWVzdCIsImdldENvbmZpZyIsImNvbnNvbGUiLCJsb2ciLCJ4aHIiLCJYTUxIdHRwUmVxdWVzdCIsIm9wZW4iLCJyZXNwb25zZVR5cGUiLCJzZXRSZXF1ZXN0SGVhZGVyIiwiZXJyb3JNc2ciLCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCJyZWFkeVN0YXRlIiwic3RhdHVzIiwiYm9keSIsIkpTT04iLCJwYXJzZSIsInJlc3BvbnNlVGV4dCIsInBheWxvYWQiLCJtb2RlbCIsInNldE1vZGVsIiwiRXJyb3IiLCJvbmxvYWQiLCJyZXNwb25zZSIsIm9uZXJyb3IiLCJzZW5kIiwidmVjdG9yIiwiRmxvYXQzMkFycmF5IiwiRmxvYXQ2NEFycmF5IiwiZmlsdGVyIiwieG1tVG9SYXBpZE1peENvbmZpZyIsImNvbmZpZyIsImRvY1R5cGUiLCJkb2NWZXJzaW9uIiwidGFyZ2V0IiwibmFtZSIsInNwbGl0IiwibGVuZ3RoIiwiaW5kZXhPZiIsInZhbCIsIm5ld01vZGVsIiwia2V5Iiwic2V0TGlrZWxpaG9vZFdpbmRvdyIsInRhcmdldHMiLCJsaWIiLCJhbGdvIiwicmFwaWRNaXhUb1htbU1vZGVsIl0sIm1hcHBpbmdzIjoiMmlDQUFBLDhDQUNBLHFDLEdBQVlBLEkscUNBQ1osb0QsOFhBRUEsR0FBTUMsUUFBUyxHQUFJQyxTQUFKLENBQWEsb0RBQWIsQ0FBZixDQUVBLEdBQU1DLGNBQWUsQ0FDbkJDLElBQUssQ0FBRSxLQUFGLENBQVMsS0FBVCxDQUFnQixNQUFoQixDQUF3QixNQUF4QixDQURjLENBQXJCLENBSUEsR0FBTUMsa0JBQW1CLENBQ3ZCQyxVQUFXLEtBRFksQ0FFdkJDLFVBQVcsQ0FGWSxDQUd2QkMsdUJBQXdCLElBSEQsQ0FJdkJDLHVCQUF3QixJQUpELENBS3ZCQyxlQUFnQixNQUxPLENBTXZCQyxhQUFjLElBTlMsQ0FPdkJDLE9BQVEsQ0FQZSxDQVF2QkMsZUFBZ0IsV0FSTyxDQVN2QkMsb0JBQXFCLE1BVEUsQ0FVdkJDLGlCQUFrQixFQVZLLENBQXpCLENBYUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztNQXdDTUMsYSxZQUNKLHVCQUVRLG9FQUFKLEVBQUksZUFETkMsR0FDTSxDQUROQSxHQUNNLHNCQURBLG9DQUNBLDBEQUNOLEtBQUtBLEdBQUwsQ0FBV0EsR0FBWCxDQUVBLEtBQUtDLE9BQUwsQ0FBZSxFQUFmLENBQ0EsS0FBS0MsUUFBTCxDQUFnQixJQUFoQixDQUNBLEtBQUtDLE1BQUwsQ0FBYyxJQUFkLENBQ0EsS0FBS0MsVUFBTCxDQUFrQixJQUFsQixDQUNBLEtBQUtDLGlCQUFMLENBQXlCLElBQXpCLENBRUEsS0FBS0MsU0FBTCxDQUFlbEIsZ0JBQWYsRUFDQSxLQUFLbUIsV0FBTCxHQUNELEMsdUZBRWEsQ0FDWixPQUFRLEtBQUtILFVBQWIsRUFDRSxJQUFLLE1BQUwsQ0FDRSxLQUFLRixRQUFMLENBQWdCLEdBQUluQixLQUFJeUIsV0FBUixDQUFvQixLQUFLSCxpQkFBekIsQ0FB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UmVxdWVzdCBhcyBYSFIgfSBmcm9tICd4bWxodHRwcmVxdWVzdCc7XG5pbXBvcnQgKiBhcyBYbW0gZnJvbSAneG1tLWNsaWVudCc7XG5pbXBvcnQgcmFwaWRNaXhBZGFwdGVycyBmcm9tICdyYXBpZC1taXgtYWRhcHRlcnMnO1xuXG5jb25zdCBpc05vZGUgPSBuZXcgRnVuY3Rpb24oXCJ0cnkge3JldHVybiB0aGlzPT09Z2xvYmFsO31jYXRjaChlKXtyZXR1cm4gZmFsc2U7fVwiKTtcblxuY29uc3Qga25vd25UYXJnZXRzID0ge1xuICB4bW06IFsgJ2dtbScsICdnbXInLCAnaGhtbScsICdoaG1yJyBdXG59O1xuXG5jb25zdCBkZWZhdWx0WG1tQ29uZmlnID0ge1xuICBtb2RlbFR5cGU6ICdnbW0nLFxuICBnYXVzc2lhbnM6IDEsXG4gIGFic29sdXRlUmVndWxhcml6YXRpb246IDAuMDEsXG4gIHJlbGF0aXZlUmVndWxhcml6YXRpb246IDAuMDEsXG4gIGNvdmFyaWFuY2VNb2RlOiAnZnVsbCcsXG4gIGhpZXJhcmNoaWNhbDogdHJ1ZSxcbiAgc3RhdGVzOiAxLFxuICB0cmFuc2l0aW9uTW9kZTogJ2xlZnRyaWdodCcsXG4gIHJlZ3Jlc3Npb25Fc3RpbWF0b3I6ICdmdWxsJyxcbiAgbGlrZWxpaG9vZFdpbmRvdzogMTAsXG59O1xuXG4vKipcbiAqIFJlcHJlc2VudGF0aW9uIG9mIGEgZ2VzdHVyZSBtb2RlbC4gQSBpbnN0YW5jZSBvZiBgWG1tUHJvY2Vzc29yYCBjYW5cbiAqIHRyYWluIGEgbW9kZWwgZnJvbSBleGFtcGxlcyBhbmQgY2FuIHBlcmZvcm0gY2xhc3NpZmljYXRpb24gYW5kL29yXG4gKiByZWdyZXNzaW9uIGRlcGVuZGluZyBvbiB0aGUgY2hvc2VuIGFsZ29yaXRobS5cbiAqXG4gKiBUaGUgdHJhaW5pbmcgaXMgY3VycmVudGx5IGJhc2VkIG9uIHRoZSBwcmVzZW5jZSBvZiBhIHJlbW90ZSBzZXJ2ZXItc2lkZVxuICogQVBJLCB0aGF0IG11c3QgYmUgYWJsZSB0byBwcm9jZXNzIHJhcGlkTWl4IGNvbXBsaWFudCBKU09OIGZvcm1hdHMuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBPdmVycmlkZSBkZWZhdWx0IHBhcmFtZXRlcnNcbiAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy51cmw9J2h0dHBzOi8vY29tby5pcmNhbS5mci9hcGkvdjEvdHJhaW4nXSAtIFVybFxuICogIG9mIHRoZSB0cmFpbmluZyBlbmQgcG9pbnQuXG4gKlxuICogQGV4YW1wbGVcbiAqIGltcG9ydCAqIGFzIG1hbm8gZnJvbSAnbWFuby1qcy9jbGllbnQnO1xuICpcbiAqIGNvbnN0IHByb2Nlc3NlZFNlbnNvcnMgPSBuZXcgbWFuby5Qcm9jZXNzZWRTZW5zb3JzKCk7XG4gKiBjb25zdCBleGFtcGxlID0gbmV3IG1hbm8uRXhhbXBsZSgpO1xuICogY29uc3QgdHJhaW5pbmdTZXQgPSBuZXcgbWFuby5UcmFpbmluZ1NldCgpO1xuICogY29uc3QgeG1tUHJvY2Vzc29yID0gbmV3IG1hbm8uWG1tUHJvY2Vzc3NvcigpO1xuICpcbiAqIGV4YW1wbGUuc2V0TGFiZWwoJ3Rlc3QnKTtcbiAqIHByb2Nlc3NlZFNlbnNvcnMuYWRkTGlzdGVuZXIoZXhhbXBsZS5hZGRFbGVtZW50KTtcbiAqXG4gKiAvLyBsYXRlclxuICogcHJvY2Vzc2VkU2Vuc29ycy5yZW1vdmVMaXN0ZW5lcihleGFtcGxlLmFkZEVsZW1lbnQpO1xuICogY29uc3QgcmFwaWRNaXhKc29uRXhhbXBsZSA9IGV4YW1wbGUudG9KU09OKCk7XG4gKlxuICogdHJhaW5pbmdTZXQuYWRkRXhhbXBsZShyYXBpZE1peEpzb25FeGFtcGxlKTtcbiAqIGNvbnN0IHJhcGlkTWl4SnNvblRyYWluaW5nU2V0ID0gdHJhaW5pbmdTZXQudG9KU09OKCk7XG4gKlxuICogeG1tUHJvY2Vzc29yXG4gKiAgIC50cmFpbihyYXBpZE1peEpzb25UcmFpbmluZ1NldClcbiAqICAgLnRoZW4oKCkgPT4ge1xuICogICAgIC8vIHN0YXJ0IGRlY29kaW5nXG4gKiAgICAgcHJvY2Vzc2VkU2Vuc29ycy5hZGRMaXN0ZW5lcihkYXRhID0+IHtcbiAqICAgICAgIGNvbnN0IHJlc3VsdHMgPSB4bW1Qcm9jZXNzb3IucnVuKGRhdGEpO1xuICogICAgICAgY29uc29sZS5sb2cocmVzdWx0cyk7XG4gKiAgICAgfSk7XG4gKiAgIH0pO1xuICovXG5jbGFzcyBYbW1Qcm9jZXNzb3Ige1xuICBjb25zdHJ1Y3Rvcih7XG4gICAgdXJsID0gJ2h0dHBzOi8vY29tby5pcmNhbS5mci9hcGkvdjEvdHJhaW4nLFxuICB9ID0ge30pIHtcbiAgICB0aGlzLnVybCA9IHVybDtcblxuICAgIHRoaXMuX2NvbmZpZyA9IHt9O1xuICAgIHRoaXMuX2RlY29kZXIgPSBudWxsO1xuICAgIHRoaXMuX21vZGVsID0gbnVsbDtcbiAgICB0aGlzLl9tb2RlbFR5cGUgPSBudWxsO1xuICAgIHRoaXMuX2xpa2VsaWhvb2RXaW5kb3cgPSBudWxsO1xuXG4gICAgdGhpcy5zZXRDb25maWcoZGVmYXVsdFhtbUNvbmZpZyk7XG4gICAgdGhpcy5fc2V0RGVjb2RlcigpO1xuICB9XG5cbiAgX3NldERlY29kZXIoKSB7XG4gICAgc3dpdGNoICh0aGlzLl9tb2RlbFR5cGUpIHtcbiAgICAgIGNhc2UgJ2hobW0nOlxuICAgICAgICB0aGlzLl9kZWNvZGVyID0gbmV3IFhtbS5IaG1tRGVjb2Rlcih0aGlzLl9saWtlbGlob29kV2luZG93KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdnbW0nOlxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhpcy5fZGVjb2RlciA9IG5ldyBYbW0uR21tRGVjb2Rlcih0aGlzLl9saWtlbGlob29kV2luZG93KTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IHRoZSBtb2RlbCdzIHRlbXBvcmFsIGRlY29kaW5nIHN0YXRlLiBJcyBvbmx5IHZhbGlkIG9uIGBoaG1tYCBkZWNvZGVyLlxuICAgKi9cbiAgcmVzZXQoKSB7XG4gICAgaWYgKHRoaXMuX2RlY29kZXIucmVzZXQpXG4gICAgICB0aGlzLl9kZWNvZGVyLnJlc2V0KCk7XG4gIH1cblxuICAvKipcbiAgICogVHJhaW4gdGhlIG1vZGVsIGFjY29yZGluZyB0byB0aGUgZ2l2ZW4gYFRyYWluaW5nU2V0YC4gSW4gdGhpcyBpbXBsbWVudGF0aW9uXG4gICAqIHRoZSB0cmFpbmluZyBpcyBwZXJmb3JtZWQgc2VydmVyLXNpZGUgYW5kIHJlbHkgb24gYW4gWEhSIGNhbGwuXG4gICAqXG4gICAqIEBwYXJhbSB7SlNPTn0gdHJhaW5pbmdTZXQgLSBSYXBpZE1peCBjb21wbGlhbnQgSlNPTiBmb3JtYXR0ZWQgdHJhaW5pbmcgc2V0XG4gICAqIEByZXR1cm4ge1Byb21pc2V9IC0gUHJvbWlzZSB0aGF0IHJlc29sdmVzIG9uIHRoZSBBUEkgcmVzcG9uc2UgKFJhcGlkTWl4IEFQSVxuICAgKiAgcmVzcG9uc2UgZm9ybWF0KSwgd2hlbiB0aGUgbW9kZWwgaXMgdXBkYXRlZC5cbiAgICovXG4gIHRyYWluKHRyYWluaW5nU2V0KSB7XG4gICAgLy8gUkVTVCByZXF1ZXN0IC8gcmVzcG9uc2UgLSBSYXBpZE1peFxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB0cmFpbmluZ0RhdGEgPSByYXBpZE1peEFkYXB0ZXJzLmNyZWF0ZUNvbW9IdHRwUmVxdWVzdCh0aGlzLmdldENvbmZpZygpLCB0cmFpbmluZ1NldCk7XG4gICAgICBjb25zb2xlLmxvZyh0cmFpbmluZ0RhdGEpO1xuXG4gICAgICBjb25zdCB4aHIgPSBpc05vZGUoKSA/IG5ldyBYSFIoKSA6IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuXG4gICAgICB4aHIub3BlbigncG9zdCcsIHRoaXMudXJsLCB0cnVlKTtcbiAgICAgIHhoci5yZXNwb25zZVR5cGUgPSAnanNvbic7XG4gICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcbiAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuXG4gICAgICBjb25zdCBlcnJvck1zZyA9ICdhbiBlcnJvciBvY2N1cmVkIHdoaWxlIHRyYWluaW5nIHRoZSBtb2RlbC4gJztcblxuICAgICAgaWYgKGlzTm9kZSgpKSB7IC8vIFhNTEh0dHBSZXF1ZXN0IG1vZHVsZSBvbmx5IHN1cHBvcnRzIHhociB2MVxuICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gKCkgPT4ge1xuICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PT0gNCkge1xuICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgICAgdGhpcy5fbW9kZWwgPSBib2R5LnBheWxvYWQubW9kZWw7XG4gICAgICAgICAgICAgIHRoaXMuX2RlY29kZXIuc2V0TW9kZWwodGhpcy5fbW9kZWwucGF5bG9hZCk7XG4gICAgICAgICAgICAgIHJlc29sdmUoYm9keSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cgKyBgcmVzcG9uc2UgOiAke3hoci5zdGF0dXN9IC0gJHt4aHIucmVzcG9uc2VUZXh0fWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHsgLy8gdXNlIHhociB2MlxuICAgICAgICB4aHIub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgIGNvbnN0IGJvZHkgPSB4aHIucmVzcG9uc2U7XG4gICAgICAgICAgICB0aGlzLl9tb2RlbCA9IGJvZHkucGF5bG9hZC5tb2RlbDtcbiAgICAgICAgICAgIHRoaXMuX2RlY29kZXIuc2V0TW9kZWwodGhpcy5fbW9kZWwucGF5bG9hZCk7XG4gICAgICAgICAgICByZXNvbHZlKGJvZHkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cgKyBgcmVzcG9uc2UgOiAke3hoci5zdGF0dXN9IC0gJHt4aHIucmVzcG9uc2V9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHhoci5vbmVycm9yID0gKCkgPT4ge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1zZyArIGByZXNwb25zZSA6ICR7eGhyLnN0YXR1c30gLSAke3hoci5yZXNwb25zZX1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB4aHIuc2VuZChKU09OLnN0cmluZ2lmeSh0cmFpbmluZ0RhdGEpKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIHRoZSBjYWxzc2lmaWNhdGlvbiBvciB0aGUgcmVncmVzc2lvbiBvZiB0aGUgZ2l2ZW4gdmVjdG9yLlxuICAgKlxuICAgKiBAcGFyYW0ge0Zsb2F0MzJBcnJheXxBcnJheX0gdmVjdG9yIC0gSW5wdXQgdmVjdG9yIGZvciB0aGUgZGVjb2RpbmcuXG4gICAqIEByZXR1cm4ge09iamVjdH0gcmVzdWx0cyAtIE9iamVjdCBjb250YWluaW5nIHRoZSBkZWNvZGluZyByZXN1bHRzLlxuICAgKi9cbiAgcnVuKHZlY3Rvcikge1xuICAgIGlmICh2ZWN0b3IgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkgfHwgdmVjdG9yIGluc3RhbmNlb2YgRmxvYXQ2NEFycmF5KSB7XG4gICAgICB2ZWN0b3IgPSBBcnJheS5mcm9tKHZlY3Rvcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2RlY29kZXIuZmlsdGVyKHZlY3Rvcik7XG4gIH1cblxuICAvKipcbiAgICogUmFwaWRNaXggY29tcGxpYW50IGNvbmZpZ3VyYXRpb24gb2JqZWN0LlxuICAgKlxuICAgKiBAcmV0dXJuIHtPYmplY3R9IC0gUmFwaWRNaXggQ29uZmlndXJhdGlvbiBvYmplY3QuXG4gICAqL1xuICBnZXRDb25maWcoKSB7XG4gICAgcmV0dXJuIHJhcGlkTWl4QWRhcHRlcnMueG1tVG9SYXBpZE1peENvbmZpZyhPYmplY3QuYXNzaWduKHt9LCB0aGlzLl9jb25maWcsIHtcbiAgICAgIG1vZGVsVHlwZTogdGhpcy5fbW9kZWxUeXBlXG4gICAgfSkpO1xuICAgIC8vIHJldHVybiB7XG4gICAgLy8gICBkb2NUeXBlOiAncmFwaWQtbWl4Om1sLWNvbmZpZ3VyYXRpb24nLFxuICAgIC8vICAgZG9jVmVyc2lvbjogcmFwaWRNaXhBZGFwdGVycy5SQVBJRF9NSVhfRE9DX1ZFUlNJT04sXG4gICAgLy8gICB0YXJnZXQ6IHtcbiAgICAvLyAgICAgbmFtZTogYHhtbToke3RoaXMuX21vZGVsVHlwZX1gLFxuICAgIC8vICAgICB2ZXJzaW9uOiAnMS4wLjAnXG4gICAgLy8gICB9LFxuICAgIC8vICAgcGF5bG9hZDogdGhpcy5fY29uZmlnLFxuICAgIC8vIH07XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBtb2RlbCBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMgKG9yIGEgc3Vic2V0IG9mIHRoZW0pLlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIC0gUmFwaWRNaXggY29uZmlndXJhdGlvbiBvYmplY3QgKG9yIHBheWxvYWQpLCBvciBzdWJzZXQgb2YgcGFyYW1ldGVycy5cbiAgICovXG4gIHNldENvbmZpZyhjb25maWcgPSB7fSkge1xuICAgIGlmICghY29uZmlnKVxuICAgICAgcmV0dXJuO1xuXG4gICAgLy8gcmVwbGFjZSBsYXRlciBieSBpc1ZhbGlkUmFwaWRNaXhDb25maWd1cmF0aW9uIChtb2RlbFR5cGUgc2hvdWxkbid0IGJlIGFsbG93ZWQgaW4gcGF5bG9hZClcbiAgICBpZiAoY29uZmlnLmRvY1R5cGUgPT09ICdyYXBpZC1taXg6bWwtY29uZmlndXJhdGlvbicgJiYgY29uZmlnLmRvY1ZlcnNpb24gJiYgY29uZmlnLnBheWxvYWQgJiZcbiAgICAgICAgY29uZmlnLnRhcmdldCAmJiBjb25maWcudGFyZ2V0Lm5hbWUgJiYgY29uZmlnLnRhcmdldC5uYW1lLnNwbGl0KCc6JylbMF0gPT09ICd4bW0nKSB7XG5cbiAgICAgIGNvbnN0IHRhcmdldCA9IGNvbmZpZy50YXJnZXQubmFtZS5zcGxpdCgnOicpO1xuICAgICAgY29uZmlnID0gY29uZmlnLnBheWxvYWQ7XG4gICAgICBpZiAodGFyZ2V0Lmxlbmd0aCA+IDEgJiYga25vd25UYXJnZXRzLnhtbS5pbmRleE9mKHRhcmdldFsxXSkgPiAtMSkge1xuICAgICAgICBpZiAodGhpcy5fbW9kZWxUeXBlICE9PSB0YXJnZXRbMV0pIHtcbiAgICAgICAgICB0aGlzLl9tb2RlbFR5cGUgPSB0YXJnZXRbMV07XG4gICAgICAgICAgdGhpcy5fc2V0RGVjb2RlcigpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy5tb2RlbFR5cGUgJiYga25vd25UYXJnZXRzWyd4bW0nXS5pbmRleE9mKGNvbmZpZy5tb2RlbFR5cGUpID4gLTEpIHtcbiAgICAgIGNvbnN0IHZhbCA9IGNvbmZpZy5tb2RlbFR5cGU7XG4gICAgICBjb25zdCBuZXdNb2RlbCA9ICh2YWwgPT09ICdnbXInKSA/ICdnbW0nIDogKCh2YWwgPT09ICdoaG1yJykgPyAnaGhtbScgOiB2YWwpO1xuXG4gICAgICBpZiAobmV3TW9kZWwgIT09IHRoaXMuX21vZGVsVHlwZSkge1xuICAgICAgICB0aGlzLl9tb2RlbFR5cGUgPSBuZXdNb2RlbDtcbiAgICAgICAgdGhpcy5fc2V0RGVjb2RlcigpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZvciAobGV0IGtleSBvZiBPYmplY3Qua2V5cyhjb25maWcpKSB7XG4gICAgICBjb25zdCB2YWwgPSBjb25maWdba2V5XTtcblxuICAgICAgaWYgKChrZXkgPT09ICdnYXVzc2lhbnMnICYmIE51bWJlci5pc0ludGVnZXIodmFsKSAmJiB2YWwgPiAwKSB8fFxuICAgICAgICAgIChrZXkgPT09ICdhYnNvbHV0ZVJlZ3VsYXJpemF0aW9uJyAmJiB0eXBlb2YgdmFsID09PSAnbnVtYmVyJyAmJiB2YWwgPiAwKSB8fFxuICAgICAgICAgIChrZXkgPT09ICdyZWxhdGl2ZVJlZ3VsYXJpemF0aW9uJyAmJiB0eXBlb2YgdmFsID09PSAnbnVtYmVyJyAmJiB2YWwgPiAwKSB8fFxuICAgICAgICAgIChrZXkgPT09ICdjb3ZhcmlhbmNlTW9kZScgJiYgdHlwZW9mIHZhbCA9PT0gJ3N0cmluZycgJiZcbiAgICAgICAgICAgIFsnZnVsbCcsICdkaWFnb25hbCddLmluZGV4T2YodmFsKSA+IC0xKSB8fFxuICAgICAgICAgIChrZXkgPT09ICdoaWVyYXJjaGljYWwnICYmIHR5cGVvZiB2YWwgPT09ICdib29sZWFuJykgfHxcbiAgICAgICAgICAoa2V5ID09PSAnc3RhdGVzJyAmJiBOdW1iZXIuaXNJbnRlZ2VyKHZhbCkgJiYgdmFsID4gMCkgfHxcbiAgICAgICAgICAoa2V5ID09PSAndHJhbnNpdGlvbk1vZGUnICYmIHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnICYmXG4gICAgICAgICAgICBbJ2xlZnRyaWdodCcsICdlcmdvZGljJ10uaW5kZXhPZih2YWwpID4gLTEpIHx8XG4gICAgICAgICAgKGtleSA9PT0gJ3JlZ3Jlc3Npb25Fc3RpbWF0b3InICYmIHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnICYmXG4gICAgICAgICAgICBbJ2Z1bGwnLCAnd2luZG93ZWQnLCAnbGlrZWxpZXN0J10uaW5kZXhPZih2YWwpID4gLTEpKSB7XG4gICAgICAgIHRoaXMuX2NvbmZpZ1trZXldID0gdmFsO1xuICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdsaWtlbGlob29kV2luZG93JyAmJiBOdW1iZXIuaXNJbnRlZ2VyKHZhbCkgJiYgdmFsID4gMCkge1xuICAgICAgICB0aGlzLl9saWtlbGlob29kV2luZG93ID0gdmFsO1xuXG4gICAgICAgIGlmICh0aGlzLl9kZWNvZGVyICE9PSBudWxsKSB7XG4gICAgICAgICAgdGhpcy5fZGVjb2Rlci5zZXRMaWtlbGlob29kV2luZG93KHRoaXMuX2xpa2VsaWhvb2RXaW5kb3cpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlIHRoZSBtb2RlbCBpbiBSYXBpZE1peCBtb2RlbCBmb3JtYXQuXG4gICAqXG4gICAqIEByZXR1cm4ge09iamVjdH0gLSBDdXJyZW50IFJhcGlkTWl4IE1vZGVsIG9iamVjdC5cbiAgICovXG4gIGdldE1vZGVsKCkge1xuICAgIHJldHVybiB0aGlzLl9tb2RlbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBVc2UgdGhlIGdpdmVuIFJhcGlkTWl4IG1vZGVsIG9iamVjdCBmb3IgdGhlIGRlY29kaW5nLlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gbW9kZWwgLSBSYXBpZE1peCBNb2RlbCBvYmplY3QuXG4gICAqL1xuICBzZXRNb2RlbChtb2RlbCkge1xuICAgIGlmICghbW9kZWwpIHtcbiAgICAgIHRoaXMubW9kZWwgPSBudWxsO1xuICAgICAgdGhpcy5fZGVjb2Rlci5zZXRNb2RlbChudWxsKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB0YXJnZXRzID0gbW9kZWwudGFyZ2V0Lm5hbWUuc3BsaXQoJzonKTtcbiAgICBjb25zdCBsaWIgPSB0YXJnZXRzWzBdO1xuICAgIGNvbnN0IGFsZ28gPSB0YXJnZXRzWzFdO1xuXG4gICAgaWYgKGxpYiA9PT0gJ3htbScpIHtcbiAgICAgIHRoaXMuX21vZGVsVHlwZSA9IGFsZ28gPT09ICdoaG1tJyA/IGFsZ28gOiAnZ21tJztcblxuICAgICAgdGhpcy5fc2V0RGVjb2RlcigpO1xuICAgICAgdGhpcy5fbW9kZWwgPSBtb2RlbDtcbiAgICAgIC8vIHRoaXMuX2RlY29kZXIuc2V0TW9kZWwobW9kZWwucGF5bG9hZCk7XG4gICAgICB0aGlzLl9kZWNvZGVyLnNldE1vZGVsKHJhcGlkTWl4QWRhcHRlcnMucmFwaWRNaXhUb1htbU1vZGVsKG1vZGVsKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCB0eXBlICR7bGlifWApO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBYbW1Qcm9jZXNzb3I7XG4iXX0=
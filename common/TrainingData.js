'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _classCallCheck2=require('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _rapidMixAdapters=require('rapid-mix-adapters');var _Example=require('./Example');var _Example2=_interopRequireDefault(_Example);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}// source : https://stackoverflow.com/questions/15251879/how-to-check-if-a-variable-is-a-typed-array-in-javascript
var isArray=function isArray(v){return v.constructor===Float32Array||v.constructor===Float64Array||Array.isArray(v);};/**
 * Manage and format a set of recorded examples, maintain a RapidMix compliant
 * training set.
 *
 * @param {Number} [inputDimension=null] - Input dimension
 *  (if `null`, is guessed from the first recorded element)
 * @param {Number} [outputDimension=null] - Output dimension.
 *  (if `null`, is guessed from the first recorded element).
 *
 * @example
 * import { ProcessedSensors, TrainingData } from 'iml-motion';
 *
 * const processedSensors = new ProcessedSensors();
 * const trainingData = new TrainingData(8);
 *
 * processedSensors.addListener(trainingData.addElement);
 * processedSensors.init()
 *   .then(() => processedSensors.start());
 */var TrainingData=function(){function TrainingData(){var inputDimension=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var outputDimension=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var columnNames=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];(0,_classCallCheck3.default)(this,TrainingData);if(inputDimension!==null){this.fixedDimensions=true;this.inputDimension=inputDimension;this.outputDimension=outputDimension!==null?outputDimension:0;}else{this.fixedDimensions=false;}this.columnNames=columnNames;this._init();}/**
   * Add an example of length 1 containing the input element data to the training set.
   * Valid argument combinations are :
   * - (inputVector)
   * - (inputVector, outputVector)
   * - (label, inputVector)
   * - (label, inputVector, outputVector).
   * Meant to be a shortcut to avoid creating examples of length 1
   * when adding single elements as examples.
   *
   * @param {String} [label=rapidMixDefaultLabel] - The label of the new element.
   * @param {Array.Number|Float32Array|Float64Array} inputVector - The input part of the new element.
   * @param {Array.Number|Float32Array|Float64Array} [outputVector=null] - The output part of the new element.
   */(0,_createClass3.default)(TrainingData,[{key:'addElement',value:function addElement(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}args=args.length>3?args.slice(0,3):args;var label=_rapidMixAdapters.constants.rapidMixDefaultLabel;var inputVector=null;var outputVector=null;switch(args.length){case 0:throw new Error('addElement needs at least an array as argument');break;case 1:if(isArray(args[0]))inputVector=args[0];else throw new Error('single argument must be an array');break;case 2:if(typeof args[0]==='string'&&isArray(args[1])){label=args[0];inputVector=args[1];}else if(isArray(args[0])&&isArray(args[1])){inputVector=args[0];outputVector=args[1];}else{throw new Error('two arguments can only be either label and inputVector, or inputVector and outputVector');}break;case 3:if(typeof args[0]==='string'&&isArray(args[1])&&isArray(args[2])){label=args[0];inputVector=args[1];outputVector=args[2];}else{throw new Error('three arguments must be label, inputVector and outputVector');}break;}var e=new _Example2.default();e.setLabel(label);e.addElement(inputVector,outputVector);this.addExample(e.getExample());}/**
   * Add an example to the training set.
   *
   * @param {Object} example - A RapidMix formatted example.
   */},{key:'addExample',value:function addExample(example){var e=example.payload;this._checkDimensions(e.input[0],e.output[0]);if(e.input.length===0){throw new Error('examples must contain at least one input vector');}this.data.push({label:e.label,input:e.input,output:e.output});}/**
   * Add all examples from another training set.
   *
   * @param {Object} trainingSet - A RapidMix compliant training set.
   */},{key:'addTrainingSet',value:function addTrainingSet(trainingSet){var examples=trainingSet.payload.data;var e=examples[0];this._checkDimensions(e.input[0],e.output[0]);for(var i=0;i<examples.length;i++){e=examples[i];this.data.push({label:e.label,input:e.input,output:e.output});}}/**
   * Sets internal data from another training set.
   *
   * @param {Object} trainingSet - A RapidMix compliant training set.
   */},{key:'setTrainingSet',value:function setTrainingSet(trainingSet){if(!trainingSet){this._init();return;}var set=trainingSet.payload;this.inputDimension=set.inputDimension;this.outputDimension=set.outputDimension;this.data=set.data;this.columnNames=set.columnNames;}/**
   * Return the RapidMix compliant training set in JSON format.
   *
   * @return {Object} - Training set.
   */},{key:'getTrainingSet',value:function getTrainingSet(){return{docType:'rapid-mix:training-set',docVersion:_rapidMixAdapters.constants.rapidMixDocVersion,payload:{inputDimension:this.inputDimension,outputDimension:this.outputDimension,data:this.data}};}/**
   * Return an array of the current training set labels.
   *
   * @return {Array.String} - Training set sorted labels.
   */},{key:'getLabels',value:function getLabels(){var labels=[];for(var i=0;i<this.data.length;i++){var label=this.data[i].label;if(labels.indexOf(label)===-1)labels.push(label);}return labels.sort();}/**
   * Clear the whole training set.
   */},{key:'clear',value:function clear(){this._init();}/** @private */},{key:'_init',value:function _init(){if(!this.fixedDimensions){this.inputDimension=null;this.outputDimension=null;}this.data=[];}/**
   * Remove all examples of a certain label.
   *
   * @param {String} label - The label of the recordings to be removed.
   */},{key:'removeExamplesByLabel',value:function removeExamplesByLabel(label){this.data=this.data.filter(function(datum){return datum.label!==label;});}/**
   * Remove example at index.
   *
   * @param {Number} index - The index of the example to remove.
   */},{key:'removeExampleAtIndex',value:function removeExampleAtIndex(index){this.data.splice(index,1);}/**
   * Get the number of recordings.
   */},{key:'_checkDimensions',/** @private */value:function _checkDimensions(inputVector,outputVector){if(!isArray(inputVector)||outputVector&&!isArray(outputVector)){throw new Error('inputFrame and outputFrame must be arrays');}// set this back to true where appropriate if we add removeExample etc methods
if(!this.inputDimension||!this.outputDimension){this.inputDimension=inputVector.length;this.outputDimension=outputVector?outputVector.length:0;// this._empty = false;
}else if(inputVector.length!=this.inputDimension||outputVector.length!=this.outputDimension){throw new Error('dimensions mismatch');}}},{key:'length',get:function get(){return this.data.length;}}]);return TrainingData;}();exports.default=TrainingData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbImlzQXJyYXkiLCJ2IiwiY29uc3RydWN0b3IiLCJGbG9hdDMyQXJyYXkiLCJGbG9hdDY0QXJyYXkiLCJBcnJheSIsIlRyYWluaW5nRGF0YSIsImlucHV0RGltZW5zaW9uIiwib3V0cHV0RGltZW5zaW9uIiwiY29sdW1uTmFtZXMiLCJmaXhlZERpbWVuc2lvbnMiLCJfaW5pdCIsImFyZ3MiLCJsZW5ndGgiLCJzbGljZSIsImxhYmVsIiwicmFwaWRNaXhEZWZhdWx0TGFiZWwiLCJpbnB1dFZlY3RvciIsIm91dHB1dFZlY3RvciIsIkVycm9yIiwiZSIsInNldExhYmVsIiwiYWRkRWxlbWVudCIsImFkZEV4YW1wbGUiLCJnZXRFeGFtcGxlIiwiZXhhbXBsZSIsInBheWxvYWQiLCJfY2hlY2tEaW1lbnNpb25zIiwiaW5wdXQiLCJvdXRwdXQiLCJkYXRhIiwicHVzaCIsInRyYWluaW5nU2V0IiwiZXhhbXBsZXMiLCJpIiwic2V0IiwiZG9jVHlwZSIsImRvY1ZlcnNpb24iLCJyYXBpZE1peERvY1ZlcnNpb24iLCJsYWJlbHMiLCJpbmRleE9mIiwic29ydCIsImZpbHRlciIsImRhdHVtIiwiaW5kZXgiLCJzcGxpY2UiXSwibWFwcGluZ3MiOiJnVUFBQSxvREFDQSxrQyxrSUFFQTtBQUNBLEdBQU1BLFNBQVUsUUFBVkEsUUFBVSxHQUFLLENBQ25CLE1BQU9DLEdBQUVDLFdBQUYsR0FBa0JDLFlBQWxCLEVBQ0FGLEVBQUVDLFdBQUYsR0FBa0JFLFlBRGxCLEVBRUFDLE1BQU1MLE9BQU4sQ0FBY0MsQ0FBZCxDQUZQLENBR0QsQ0FKRCxDQU1BOzs7Ozs7Ozs7Ozs7Ozs7Ozs7TUFtQk1LLGEsWUFDSix1QkFBNkUsSUFBakVDLGVBQWlFLDJEQUFoRCxJQUFnRCxJQUExQ0MsZ0JBQTBDLDJEQUF4QixJQUF3QixJQUFsQkMsWUFBa0IsMkRBQUosRUFBSSxpREFDM0UsR0FBSUYsaUJBQW1CLElBQXZCLENBQTZCLENBQzNCLEtBQUtHLGVBQUwsQ0FBdUIsSUFBdkIsQ0FDQSxLQUFLSCxjQUFMLENBQXNCQSxjQUF0QixDQUNBLEtBQUtDLGVBQUwsQ0FBdUJBLGtCQUFvQixJQUFwQixDQUEyQkEsZUFBM0IsQ0FBNkMsQ0FBcEUsQ0FDRCxDQUpELElBSU8sQ0FDTCxLQUFLRSxlQUFMLENBQXVCLEtBQXZCLENBQ0QsQ0FFRCxLQUFLRCxXQUFMLENBQW1CQSxXQUFuQixDQUNBLEtBQUtFLEtBQUwsR0FDRCxDQUVEOzs7Ozs7Ozs7Ozs7OzBGQWNvQiwrQkFBTkMsSUFBTSxzQ0FBTkEsSUFBTSx3QkFDbEJBLEtBQU9BLEtBQUtDLE1BQUwsQ0FBYyxDQUFkLENBQWtCRCxLQUFLRSxLQUFMLENBQVcsQ0FBWCxDQUFjLENBQWQsQ0FBbEIsQ0FBcUNGLElBQTVDLENBRUEsR0FBSUcsT0FBUSw0QkFBa0JDLG9CQUE5QixDQUNBLEdBQUlDLGFBQWMsSUFBbEIsQ0FDQSxHQUFJQyxjQUFlLElBQW5CLENBRUEsT0FBUU4sS0FBS0MsTUFBYixFQUNFLElBQUssRUFBTCxDQUNFLEtBQU0sSUFBSU0sTUFBSixDQUFVLGdEQUFWLENBQU4sQ0FDQSxNQUNGLElBQUssRUFBTCxDQUNFLEdBQUluQixRQUFRWSxLQUFLLENBQUwsQ0FBUixDQUFKLENBQ0VLLFlBQWNMLEtBQUssQ0FBTCxDQUFkLENBREYsSUFHRSxNQUFNLElBQUlPLE1BQUosQ0FBVSxrQ0FBVixDQUFOLENBQ0YsTUFDRixJQUFLLEVBQUwsQ0FDRSxHQUFJLE1BQU9QLE1BQUssQ0FBTCxDQUFQLEdBQW1CLFFBQW5CLEVBQStCWixRQUFRWSxLQUFLLENBQUwsQ0FBUixDQUFuQyxDQUFxRCxDQUNuREcsTUFBUUgsS0FBSyxDQUFMLENBQVIsQ0FDQUssWUFBY0wsS0FBSyxDQUFMLENBQWQsQ0FDRCxDQUhELElBR08sSUFBSVosUUFBUVksS0FBSyxDQUFMLENBQVIsR0FBb0JaLFFBQVFZLEtBQUssQ0FBTCxDQUFSLENBQXhCLENBQTBDLENBQy9DSyxZQUFjTCxLQUFLLENBQUwsQ0FBZCxDQUNBTSxhQUFlTixLQUFLLENBQUwsQ0FBZixDQUNELENBSE0sSUFHQSxDQUNMLEtBQU0sSUFBSU8sTUFBSixDQUFVLHlGQUFWLENBQU4sQ0FDRCxDQUNELE1BQ0YsSUFBSyxFQUFMLENBQ0UsR0FBSSxNQUFPUCxNQUFLLENBQUwsQ0FBUCxHQUFtQixRQUFuQixFQUErQlosUUFBUVksS0FBSyxDQUFMLENBQVIsQ0FBL0IsRUFBbURaLFFBQVFZLEtBQUssQ0FBTCxDQUFSLENBQXZELENBQXlFLENBQ3ZFRyxNQUFRSCxLQUFLLENBQUwsQ0FBUixDQUNBSyxZQUFjTCxLQUFLLENBQUwsQ0FBZCxDQUNBTSxhQUFlTixLQUFLLENBQUwsQ0FBZixDQUNELENBSkQsSUFJTyxDQUNMLEtBQU0sSUFBSU8sTUFBSixDQUFVLDZEQUFWLENBQU4sQ0FDRCxDQUNELE1BN0JKLENBZ0NBLEdBQU1DLEdBQUksdUJBQVYsQ0FDQUEsRUFBRUMsUUFBRixDQUFXTixLQUFYLEVBQ0FLLEVBQUVFLFVBQUYsQ0FBYUwsV0FBYixDQUEwQkMsWUFBMUIsRUFDQSxLQUFLSyxVQUFMLENBQWdCSCxFQUFFSSxVQUFGLEVBQWhCLEVBQ0QsQ0FFRDs7OzttREFLV0MsTyxDQUFTLENBQ2xCLEdBQU1MLEdBQUlLLFFBQVFDLE9BQWxCLENBQ0EsS0FBS0MsZ0JBQUwsQ0FBc0JQLEVBQUVRLEtBQUYsQ0FBUSxDQUFSLENBQXRCLENBQWtDUixFQUFFUyxNQUFGLENBQVMsQ0FBVCxDQUFsQyxFQUVBLEdBQUlULEVBQUVRLEtBQUYsQ0FBUWYsTUFBUixHQUFtQixDQUF2QixDQUEwQixDQUN4QixLQUFNLElBQUlNLE1BQUosQ0FBVSxpREFBVixDQUFOLENBQ0QsQ0FFRCxLQUFLVyxJQUFMLENBQVVDLElBQVYsQ0FBZSxDQUNiaEIsTUFBT0ssRUFBRUwsS0FESSxDQUViYSxNQUFPUixFQUFFUSxLQUZJLENBR2JDLE9BQVFULEVBQUVTLE1BSEcsQ0FBZixFQUtELENBRUQ7Ozs7MkRBS2VHLFcsQ0FBYSxDQUMxQixHQUFNQyxVQUFXRCxZQUFZTixPQUFaLENBQW9CSSxJQUFyQyxDQUNBLEdBQUlWLEdBQUlhLFNBQVMsQ0FBVCxDQUFSLENBQ0EsS0FBS04sZ0JBQUwsQ0FBc0JQLEVBQUVRLEtBQUYsQ0FBUSxDQUFSLENBQXRCLENBQWtDUixFQUFFUyxNQUFGLENBQVMsQ0FBVCxDQUFsQyxFQUVBLElBQUssR0FBSUssR0FBSSxDQUFiLENBQWdCQSxFQUFJRCxTQUFTcEIsTUFBN0IsQ0FBcUNxQixHQUFyQyxDQUEwQyxDQUN4Q2QsRUFBSWEsU0FBU0MsQ0FBVCxDQUFKLENBRUEsS0FBS0osSUFBTCxDQUFVQyxJQUFWLENBQWUsQ0FDYmhCLE1BQU9LLEVBQUVMLEtBREksQ0FFYmEsTUFBT1IsRUFBRVEsS0FGSSxDQUdiQyxPQUFRVCxFQUFFUyxNQUhHLENBQWYsRUFLRCxDQUNGLENBRUQ7Ozs7MkRBS2VHLFcsQ0FBYSxDQUMxQixHQUFJLENBQUNBLFdBQUwsQ0FBa0IsQ0FDaEIsS0FBS3JCLEtBQUwsR0FDQSxPQUNELENBRUQsR0FBTXdCLEtBQU1ILFlBQVlOLE9BQXhCLENBRUEsS0FBS25CLGNBQUwsQ0FBc0I0QixJQUFJNUIsY0FBMUIsQ0FDQSxLQUFLQyxlQUFMLENBQXVCMkIsSUFBSTNCLGVBQTNCLENBQ0EsS0FBS3NCLElBQUwsQ0FBWUssSUFBSUwsSUFBaEIsQ0FDQSxLQUFLckIsV0FBTCxDQUFtQjBCLElBQUkxQixXQUF2QixDQUNELENBRUQ7Ozs7NERBS2lCLENBQ2YsTUFBTyxDQUNMMkIsUUFBUyx3QkFESixDQUVMQyxXQUFZLDRCQUFrQkMsa0JBRnpCLENBR0xaLFFBQVMsQ0FDUG5CLGVBQWdCLEtBQUtBLGNBRGQsQ0FFUEMsZ0JBQWlCLEtBQUtBLGVBRmYsQ0FHUHNCLEtBQU0sS0FBS0EsSUFISixDQUhKLENBQVAsQ0FTRCxDQUVEOzs7O2tEQUtZLENBQ1YsR0FBTVMsUUFBUyxFQUFmLENBRUEsSUFBSyxHQUFJTCxHQUFJLENBQWIsQ0FBZ0JBLEVBQUksS0FBS0osSUFBTCxDQUFVakIsTUFBOUIsQ0FBc0NxQixHQUF0QyxDQUEyQyxDQUN6QyxHQUFNbkIsT0FBUSxLQUFLZSxJQUFMLENBQVVJLENBQVYsRUFBYW5CLEtBQTNCLENBRUEsR0FBSXdCLE9BQU9DLE9BQVAsQ0FBZXpCLEtBQWYsSUFBMEIsQ0FBQyxDQUEvQixDQUNFd0IsT0FBT1IsSUFBUCxDQUFZaEIsS0FBWixFQUNILENBRUQsTUFBT3dCLFFBQU9FLElBQVAsRUFBUCxDQUNELENBRUQ7OzBDQUdRLENBQ04sS0FBSzlCLEtBQUwsR0FDRCxDQUVELGUscUNBQ1EsQ0FDTixHQUFJLENBQUMsS0FBS0QsZUFBVixDQUEyQixDQUN6QixLQUFLSCxjQUFMLENBQXNCLElBQXRCLENBQ0EsS0FBS0MsZUFBTCxDQUF1QixJQUF2QixDQUNELENBRUQsS0FBS3NCLElBQUwsQ0FBWSxFQUFaLENBQ0QsQ0FFRDs7Ozt5RUFLc0JmLEssQ0FBTyxDQUMzQixLQUFLZSxJQUFMLENBQVksS0FBS0EsSUFBTCxDQUFVWSxNQUFWLENBQWlCLHNCQUFTQyxPQUFNNUIsS0FBTixHQUFnQkEsS0FBekIsRUFBakIsQ0FBWixDQUNELENBRUQ7Ozs7dUVBS3FCNkIsSyxDQUFPLENBQzFCLEtBQUtkLElBQUwsQ0FBVWUsTUFBVixDQUFpQkQsS0FBakIsQ0FBd0IsQ0FBeEIsRUFDRCxDQUVEOzsrQkFPQSxlLGdDQUNpQjNCLFcsQ0FBYUMsWSxDQUFjLENBQzFDLEdBQUksQ0FBQ2xCLFFBQVFpQixXQUFSLENBQUQsRUFBMEJDLGNBQWdCLENBQUNsQixRQUFRa0IsWUFBUixDQUEvQyxDQUF1RSxDQUNyRSxLQUFNLElBQUlDLE1BQUosQ0FBVSwyQ0FBVixDQUFOLENBQ0QsQ0FDRDtBQUNBLEdBQUksQ0FBQyxLQUFLWixjQUFOLEVBQXdCLENBQUMsS0FBS0MsZUFBbEMsQ0FBbUQsQ0FDakQsS0FBS0QsY0FBTCxDQUFzQlUsWUFBWUosTUFBbEMsQ0FDQSxLQUFLTCxlQUFMLENBQXVCVSxhQUFlQSxhQUFhTCxNQUE1QixDQUFxQyxDQUE1RCxDQUNBO0FBQ0QsQ0FKRCxJQUlPLElBQUlJLFlBQVlKLE1BQVosRUFBc0IsS0FBS04sY0FBM0IsRUFDRFcsYUFBYUwsTUFBYixFQUF1QixLQUFLTCxlQUQvQixDQUNnRCxDQUNyRCxLQUFNLElBQUlXLE1BQUosQ0FBVSxxQkFBVixDQUFOLENBQ0QsQ0FDRixDLGtDQWxCWSxDQUNYLE1BQU8sTUFBS1csSUFBTCxDQUFVakIsTUFBakIsQ0FDRCxDLDRDQW1CWVAsWSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbnN0YW50cyBhcyByYXBpZE1peENvbnN0YW50cyB9IGZyb20gJ3JhcGlkLW1peC1hZGFwdGVycyc7XG5pbXBvcnQgRXhhbXBsZSBmcm9tICcuL0V4YW1wbGUnO1xuXG4vLyBzb3VyY2UgOiBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xNTI1MTg3OS9ob3ctdG8tY2hlY2staWYtYS12YXJpYWJsZS1pcy1hLXR5cGVkLWFycmF5LWluLWphdmFzY3JpcHRcbmNvbnN0IGlzQXJyYXkgPSB2ID0+IHtcbiAgcmV0dXJuIHYuY29uc3RydWN0b3IgPT09IEZsb2F0MzJBcnJheSB8fFxuICAgICAgICAgdi5jb25zdHJ1Y3RvciA9PT0gRmxvYXQ2NEFycmF5IHx8XG4gICAgICAgICBBcnJheS5pc0FycmF5KHYpO1xufTtcblxuLyoqXG4gKiBNYW5hZ2UgYW5kIGZvcm1hdCBhIHNldCBvZiByZWNvcmRlZCBleGFtcGxlcywgbWFpbnRhaW4gYSBSYXBpZE1peCBjb21wbGlhbnRcbiAqIHRyYWluaW5nIHNldC5cbiAqXG4gKiBAcGFyYW0ge051bWJlcn0gW2lucHV0RGltZW5zaW9uPW51bGxdIC0gSW5wdXQgZGltZW5zaW9uXG4gKiAgKGlmIGBudWxsYCwgaXMgZ3Vlc3NlZCBmcm9tIHRoZSBmaXJzdCByZWNvcmRlZCBlbGVtZW50KVxuICogQHBhcmFtIHtOdW1iZXJ9IFtvdXRwdXREaW1lbnNpb249bnVsbF0gLSBPdXRwdXQgZGltZW5zaW9uLlxuICogIChpZiBgbnVsbGAsIGlzIGd1ZXNzZWQgZnJvbSB0aGUgZmlyc3QgcmVjb3JkZWQgZWxlbWVudCkuXG4gKlxuICogQGV4YW1wbGVcbiAqIGltcG9ydCB7IFByb2Nlc3NlZFNlbnNvcnMsIFRyYWluaW5nRGF0YSB9IGZyb20gJ2ltbC1tb3Rpb24nO1xuICpcbiAqIGNvbnN0IHByb2Nlc3NlZFNlbnNvcnMgPSBuZXcgUHJvY2Vzc2VkU2Vuc29ycygpO1xuICogY29uc3QgdHJhaW5pbmdEYXRhID0gbmV3IFRyYWluaW5nRGF0YSg4KTtcbiAqXG4gKiBwcm9jZXNzZWRTZW5zb3JzLmFkZExpc3RlbmVyKHRyYWluaW5nRGF0YS5hZGRFbGVtZW50KTtcbiAqIHByb2Nlc3NlZFNlbnNvcnMuaW5pdCgpXG4gKiAgIC50aGVuKCgpID0+IHByb2Nlc3NlZFNlbnNvcnMuc3RhcnQoKSk7XG4gKi9cbmNsYXNzIFRyYWluaW5nRGF0YSB7XG4gIGNvbnN0cnVjdG9yKGlucHV0RGltZW5zaW9uID0gbnVsbCwgb3V0cHV0RGltZW5zaW9uID0gbnVsbCwgY29sdW1uTmFtZXMgPSBbXSkge1xuICAgIGlmIChpbnB1dERpbWVuc2lvbiAhPT0gbnVsbCkge1xuICAgICAgdGhpcy5maXhlZERpbWVuc2lvbnMgPSB0cnVlO1xuICAgICAgdGhpcy5pbnB1dERpbWVuc2lvbiA9IGlucHV0RGltZW5zaW9uO1xuICAgICAgdGhpcy5vdXRwdXREaW1lbnNpb24gPSBvdXRwdXREaW1lbnNpb24gIT09IG51bGwgPyBvdXRwdXREaW1lbnNpb24gOiAwO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZpeGVkRGltZW5zaW9ucyA9IGZhbHNlO1xuICAgIH1cblxuICAgIHRoaXMuY29sdW1uTmFtZXMgPSBjb2x1bW5OYW1lcztcbiAgICB0aGlzLl9pbml0KCk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGFuIGV4YW1wbGUgb2YgbGVuZ3RoIDEgY29udGFpbmluZyB0aGUgaW5wdXQgZWxlbWVudCBkYXRhIHRvIHRoZSB0cmFpbmluZyBzZXQuXG4gICAqIFZhbGlkIGFyZ3VtZW50IGNvbWJpbmF0aW9ucyBhcmUgOlxuICAgKiAtIChpbnB1dFZlY3RvcilcbiAgICogLSAoaW5wdXRWZWN0b3IsIG91dHB1dFZlY3RvcilcbiAgICogLSAobGFiZWwsIGlucHV0VmVjdG9yKVxuICAgKiAtIChsYWJlbCwgaW5wdXRWZWN0b3IsIG91dHB1dFZlY3RvcikuXG4gICAqIE1lYW50IHRvIGJlIGEgc2hvcnRjdXQgdG8gYXZvaWQgY3JlYXRpbmcgZXhhbXBsZXMgb2YgbGVuZ3RoIDFcbiAgICogd2hlbiBhZGRpbmcgc2luZ2xlIGVsZW1lbnRzIGFzIGV4YW1wbGVzLlxuICAgKlxuICAgKiBAcGFyYW0ge1N0cmluZ30gW2xhYmVsPXJhcGlkTWl4RGVmYXVsdExhYmVsXSAtIFRoZSBsYWJlbCBvZiB0aGUgbmV3IGVsZW1lbnQuXG4gICAqIEBwYXJhbSB7QXJyYXkuTnVtYmVyfEZsb2F0MzJBcnJheXxGbG9hdDY0QXJyYXl9IGlucHV0VmVjdG9yIC0gVGhlIGlucHV0IHBhcnQgb2YgdGhlIG5ldyBlbGVtZW50LlxuICAgKiBAcGFyYW0ge0FycmF5Lk51bWJlcnxGbG9hdDMyQXJyYXl8RmxvYXQ2NEFycmF5fSBbb3V0cHV0VmVjdG9yPW51bGxdIC0gVGhlIG91dHB1dCBwYXJ0IG9mIHRoZSBuZXcgZWxlbWVudC5cbiAgICovXG4gIGFkZEVsZW1lbnQoLi4uYXJncykge1xuICAgIGFyZ3MgPSBhcmdzLmxlbmd0aCA+IDMgPyBhcmdzLnNsaWNlKDAsIDMpIDogYXJncztcblxuICAgIGxldCBsYWJlbCA9IHJhcGlkTWl4Q29uc3RhbnRzLnJhcGlkTWl4RGVmYXVsdExhYmVsO1xuICAgIGxldCBpbnB1dFZlY3RvciA9IG51bGw7XG4gICAgbGV0IG91dHB1dFZlY3RvciA9IG51bGw7XG5cbiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7XG4gICAgICBjYXNlIDA6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignYWRkRWxlbWVudCBuZWVkcyBhdCBsZWFzdCBhbiBhcnJheSBhcyBhcmd1bWVudCcpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMTpcbiAgICAgICAgaWYgKGlzQXJyYXkoYXJnc1swXSkpXG4gICAgICAgICAgaW5wdXRWZWN0b3IgPSBhcmdzWzBdO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzaW5nbGUgYXJndW1lbnQgbXVzdCBiZSBhbiBhcnJheScpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMjpcbiAgICAgICAgaWYgKHR5cGVvZiBhcmdzWzBdID09PSAnc3RyaW5nJyAmJiBpc0FycmF5KGFyZ3NbMV0pKSB7XG4gICAgICAgICAgbGFiZWwgPSBhcmdzWzBdO1xuICAgICAgICAgIGlucHV0VmVjdG9yID0gYXJnc1sxXTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KGFyZ3NbMF0pICYmIGlzQXJyYXkoYXJnc1sxXSkpIHtcbiAgICAgICAgICBpbnB1dFZlY3RvciA9IGFyZ3NbMF07XG4gICAgICAgICAgb3V0cHV0VmVjdG9yID0gYXJnc1sxXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3R3byBhcmd1bWVudHMgY2FuIG9ubHkgYmUgZWl0aGVyIGxhYmVsIGFuZCBpbnB1dFZlY3Rvciwgb3IgaW5wdXRWZWN0b3IgYW5kIG91dHB1dFZlY3RvcicpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAzOlxuICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnICYmIGlzQXJyYXkoYXJnc1sxXSkgJiYgaXNBcnJheShhcmdzWzJdKSkge1xuICAgICAgICAgIGxhYmVsID0gYXJnc1swXTtcbiAgICAgICAgICBpbnB1dFZlY3RvciA9IGFyZ3NbMV07XG4gICAgICAgICAgb3V0cHV0VmVjdG9yID0gYXJnc1syXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3RocmVlIGFyZ3VtZW50cyBtdXN0IGJlIGxhYmVsLCBpbnB1dFZlY3RvciBhbmQgb3V0cHV0VmVjdG9yJyk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgY29uc3QgZSA9IG5ldyBFeGFtcGxlKCk7XG4gICAgZS5zZXRMYWJlbChsYWJlbCk7XG4gICAgZS5hZGRFbGVtZW50KGlucHV0VmVjdG9yLCBvdXRwdXRWZWN0b3IpO1xuICAgIHRoaXMuYWRkRXhhbXBsZShlLmdldEV4YW1wbGUoKSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGFuIGV4YW1wbGUgdG8gdGhlIHRyYWluaW5nIHNldC5cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IGV4YW1wbGUgLSBBIFJhcGlkTWl4IGZvcm1hdHRlZCBleGFtcGxlLlxuICAgKi9cbiAgYWRkRXhhbXBsZShleGFtcGxlKSB7XG4gICAgY29uc3QgZSA9IGV4YW1wbGUucGF5bG9hZDtcbiAgICB0aGlzLl9jaGVja0RpbWVuc2lvbnMoZS5pbnB1dFswXSwgZS5vdXRwdXRbMF0pO1xuXG4gICAgaWYgKGUuaW5wdXQubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2V4YW1wbGVzIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgaW5wdXQgdmVjdG9yJyk7XG4gICAgfVxuXG4gICAgdGhpcy5kYXRhLnB1c2goe1xuICAgICAgbGFiZWw6IGUubGFiZWwsXG4gICAgICBpbnB1dDogZS5pbnB1dCxcbiAgICAgIG91dHB1dDogZS5vdXRwdXQsXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGFsbCBleGFtcGxlcyBmcm9tIGFub3RoZXIgdHJhaW5pbmcgc2V0LlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gdHJhaW5pbmdTZXQgLSBBIFJhcGlkTWl4IGNvbXBsaWFudCB0cmFpbmluZyBzZXQuXG4gICAqL1xuICBhZGRUcmFpbmluZ1NldCh0cmFpbmluZ1NldCkge1xuICAgIGNvbnN0IGV4YW1wbGVzID0gdHJhaW5pbmdTZXQucGF5bG9hZC5kYXRhO1xuICAgIGxldCBlID0gZXhhbXBsZXNbMF07XG4gICAgdGhpcy5fY2hlY2tEaW1lbnNpb25zKGUuaW5wdXRbMF0sIGUub3V0cHV0WzBdKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXhhbXBsZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGUgPSBleGFtcGxlc1tpXTtcblxuICAgICAgdGhpcy5kYXRhLnB1c2goe1xuICAgICAgICBsYWJlbDogZS5sYWJlbCxcbiAgICAgICAgaW5wdXQ6IGUuaW5wdXQsXG4gICAgICAgIG91dHB1dDogZS5vdXRwdXQsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0cyBpbnRlcm5hbCBkYXRhIGZyb20gYW5vdGhlciB0cmFpbmluZyBzZXQuXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSB0cmFpbmluZ1NldCAtIEEgUmFwaWRNaXggY29tcGxpYW50IHRyYWluaW5nIHNldC5cbiAgICovXG4gIHNldFRyYWluaW5nU2V0KHRyYWluaW5nU2V0KSB7XG4gICAgaWYgKCF0cmFpbmluZ1NldCkge1xuICAgICAgdGhpcy5faW5pdCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHNldCA9IHRyYWluaW5nU2V0LnBheWxvYWQ7XG5cbiAgICB0aGlzLmlucHV0RGltZW5zaW9uID0gc2V0LmlucHV0RGltZW5zaW9uO1xuICAgIHRoaXMub3V0cHV0RGltZW5zaW9uID0gc2V0Lm91dHB1dERpbWVuc2lvbjtcbiAgICB0aGlzLmRhdGEgPSBzZXQuZGF0YTtcbiAgICB0aGlzLmNvbHVtbk5hbWVzID0gc2V0LmNvbHVtbk5hbWVzO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiB0aGUgUmFwaWRNaXggY29tcGxpYW50IHRyYWluaW5nIHNldCBpbiBKU09OIGZvcm1hdC5cbiAgICpcbiAgICogQHJldHVybiB7T2JqZWN0fSAtIFRyYWluaW5nIHNldC5cbiAgICovXG4gIGdldFRyYWluaW5nU2V0KCkge1xuICAgIHJldHVybiB7XG4gICAgICBkb2NUeXBlOiAncmFwaWQtbWl4OnRyYWluaW5nLXNldCcsXG4gICAgICBkb2NWZXJzaW9uOiByYXBpZE1peENvbnN0YW50cy5yYXBpZE1peERvY1ZlcnNpb24sXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIGlucHV0RGltZW5zaW9uOiB0aGlzLmlucHV0RGltZW5zaW9uLFxuICAgICAgICBvdXRwdXREaW1lbnNpb246IHRoaXMub3V0cHV0RGltZW5zaW9uLFxuICAgICAgICBkYXRhOiB0aGlzLmRhdGEsXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gYW4gYXJyYXkgb2YgdGhlIGN1cnJlbnQgdHJhaW5pbmcgc2V0IGxhYmVscy5cbiAgICpcbiAgICogQHJldHVybiB7QXJyYXkuU3RyaW5nfSAtIFRyYWluaW5nIHNldCBzb3J0ZWQgbGFiZWxzLlxuICAgKi9cbiAgZ2V0TGFiZWxzKCkge1xuICAgIGNvbnN0IGxhYmVscyA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGxhYmVsID0gdGhpcy5kYXRhW2ldLmxhYmVsO1xuXG4gICAgICBpZiAobGFiZWxzLmluZGV4T2YobGFiZWwpID09PSAtMSlcbiAgICAgICAgbGFiZWxzLnB1c2gobGFiZWwpO1xuICAgIH1cblxuICAgIHJldHVybiBsYWJlbHMuc29ydCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIHRoZSB3aG9sZSB0cmFpbmluZyBzZXQuXG4gICAqL1xuICBjbGVhcigpIHtcbiAgICB0aGlzLl9pbml0KCk7XG4gIH1cblxuICAvKiogQHByaXZhdGUgKi9cbiAgX2luaXQoKSB7XG4gICAgaWYgKCF0aGlzLmZpeGVkRGltZW5zaW9ucykge1xuICAgICAgdGhpcy5pbnB1dERpbWVuc2lvbiA9IG51bGw7XG4gICAgICB0aGlzLm91dHB1dERpbWVuc2lvbiA9IG51bGw7XG4gICAgfVxuXG4gICAgdGhpcy5kYXRhID0gW107XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGFsbCBleGFtcGxlcyBvZiBhIGNlcnRhaW4gbGFiZWwuXG4gICAqXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCAtIFRoZSBsYWJlbCBvZiB0aGUgcmVjb3JkaW5ncyB0byBiZSByZW1vdmVkLlxuICAgKi9cbiAgcmVtb3ZlRXhhbXBsZXNCeUxhYmVsKGxhYmVsKSB7XG4gICAgdGhpcy5kYXRhID0gdGhpcy5kYXRhLmZpbHRlcihkYXR1bSA9PiBkYXR1bS5sYWJlbCAhPT0gbGFiZWwpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBleGFtcGxlIGF0IGluZGV4LlxuICAgKlxuICAgKiBAcGFyYW0ge051bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIGV4YW1wbGUgdG8gcmVtb3ZlLlxuICAgKi9cbiAgcmVtb3ZlRXhhbXBsZUF0SW5kZXgoaW5kZXgpIHtcbiAgICB0aGlzLmRhdGEuc3BsaWNlKGluZGV4LCAxKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIG51bWJlciBvZiByZWNvcmRpbmdzLlxuICAgKi9cbiAgZ2V0IGxlbmd0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhLmxlbmd0aDtcbiAgfVxuXG4gIC8qKiBAcHJpdmF0ZSAqL1xuICBfY2hlY2tEaW1lbnNpb25zKGlucHV0VmVjdG9yLCBvdXRwdXRWZWN0b3IpwqB7XG4gICAgaWYgKCFpc0FycmF5KGlucHV0VmVjdG9yKSB8fCAob3V0cHV0VmVjdG9yICYmICFpc0FycmF5KG91dHB1dFZlY3RvcikpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2lucHV0RnJhbWUgYW5kIG91dHB1dEZyYW1lIG11c3QgYmUgYXJyYXlzJyk7XG4gICAgfVxuICAgIC8vIHNldCB0aGlzIGJhY2sgdG8gdHJ1ZSB3aGVyZSBhcHByb3ByaWF0ZSBpZiB3ZSBhZGQgcmVtb3ZlRXhhbXBsZSBldGMgbWV0aG9kc1xuICAgIGlmICghdGhpcy5pbnB1dERpbWVuc2lvbiB8fCAhdGhpcy5vdXRwdXREaW1lbnNpb24pIHtcbiAgICAgIHRoaXMuaW5wdXREaW1lbnNpb24gPSBpbnB1dFZlY3Rvci5sZW5ndGg7XG4gICAgICB0aGlzLm91dHB1dERpbWVuc2lvbiA9IG91dHB1dFZlY3RvciA/IG91dHB1dFZlY3Rvci5sZW5ndGggOiAwO1xuICAgICAgLy8gdGhpcy5fZW1wdHkgPSBmYWxzZTtcbiAgICB9IGVsc2UgaWYgKGlucHV0VmVjdG9yLmxlbmd0aCAhPSB0aGlzLmlucHV0RGltZW5zaW9uIHx8XG4gICAgICAgICAgICAgIG91dHB1dFZlY3Rvci5sZW5ndGggIT0gdGhpcy5vdXRwdXREaW1lbnNpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZGltZW5zaW9ucyBtaXNtYXRjaCcpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBUcmFpbmluZ0RhdGE7XG4iXX0=
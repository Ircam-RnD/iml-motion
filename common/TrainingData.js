'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _classCallCheck2=require('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _rapidMixAdapters=require('rapid-mix-adapters');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}// source : https://stackoverflow.com/questions/15251879/how-to-check-if-a-variable-is-a-typed-array-in-javascript
var isArray=function isArray(v){return v.constructor===Float32Array||v.constructor===Float64Array||Array.isArray(v);};/**
 * Manage and format a set of recorded examples, maintain a RapidMix compliant
 * training set.
 *
 * @param {Number} [inputDimension=null] - Input dimension
 *  (if `null`, is guessed from the first recorded element)
 * @param {Number} [outputDimension=null] - Output dimension.
 *  (if `null`, is guessed from the first recorded element).
 *
 * @example
 * import { ProcessedSensors, TrainingData } from 'iml-motion';
 *
 * const processedSensors = new ProcessedSensors();
 * const trainingData = new TrainingData(8);
 *
 * processedSensors.addListener(trainingData.addElement);
 * processedSensors.init()
 *   .then(() => processedSensors.start());
 */var TrainingData=function(){function TrainingData(){var inputDimension=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var outputDimension=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var columnNames=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];(0,_classCallCheck3.default)(this,TrainingData);if(inputDimension!==null){this.fixedDimensions=true;this.inputDimension=inputDimension;this.outputDimension=outputDimension!==null?outputDimension:0;}else{this.fixedDimensions=false;}this.columnNames=columnNames;this._init();}/**
   * Add an example of length 1 containing the input element data to the training set.
   * Valid argument combinations are :
   * - (inputVector)
   * - (inputVector, outputVector)
   * - (label, inputVector)
   * - (label, inputVector, outputVector).
   * Meant to be a shortcut to avoid creating examples of length 1
   * when adding single elements as examples.
   *
   * @param {String} [label=rapidMixDefaultLabel] - The label of the new element.
   * @param {Array.Number|Float32Array|Float64Array} inputVector - The input part of the new element.
   * @param {Array.Number|Float32Array|Float64Array} [outputVector=null] - The output part of the new element.
   */(0,_createClass3.default)(TrainingData,[{key:'addElement',value:function addElement(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}args=args.length>3?args.slice(0,3):args;var label=_rapidMixAdapters.constants.rapidMixDefaultLabel;var inputVector=null;var outputVector=null;switch(args.length){case 0:throw new Error('addElement needs at least an array as argument');break;case 1:if(isArray(args[0]))inputVector=args[0];else throw new Error('single argument must be an array');break;case 2:if(typeof args[0]==='string'&&isArray(args[1])){label=args[0];inputVector=args[1];}else if(isArray(args[0])&&isArray(args[1])){inputVector=args[0];outputVector=args[1];}else{throw new Error('two arguments can only be either label and inputVector, or inputVector and outputVector');}break;case 3:if(typeof args[0]==='string'&&isArray(args[1])&&isArray(args[2])){label=args[0];inputVector=args[1];outputVector=args[2];}else{throw new Error('three arguments must be label, inputVector and outputVector');}break;}var e=new Example();e.setLabel(label);e.addElement(inputVector,outputVector);this.addExample(e.getExample());}/**
   * Add an example to the training set.
   *
   * @param {Object} example - A RapidMix formatted example.
   */},{key:'addExample',value:function addExample(example){var e=example.payload;this._checkDimensions(e.input[0],e.output[0]);if(e.input.length===0){throw new Error('examples must contain at least one input vector');}this.data.push({label:e.label,input:e.input,output:e.output});}/**
   * Add all examples from another training set.
   *
   * @param {Object} trainingSet - A RapidMix compliant training set.
   */},{key:'addTrainingSet',value:function addTrainingSet(trainingSet){var examples=trainingSet.payload.data;var e=examples[0];this._checkDimensions(e.input[0],e.output[0]);for(var i=0;i<examples.length;i++){e=examples[i];this.data.push({label:e.label,input:e.input,output:e.output});}}/**
   * Sets internal data from another training set.
   *
   * @param {Object} trainingSet - A RapidMix compliant training set.
   */},{key:'setTrainingSet',value:function setTrainingSet(trainingSet){if(!trainingSet){this._init();return;}var set=trainingSet.payload;this.inputDimension=set.inputDimension;this.outputDimension=set.outputDimension;this.data=set.data;this.columnNames=set.columnNames;}/**
   * Return the RapidMix compliant training set in JSON format.
   *
   * @return {Object} - Training set.
   */},{key:'getTrainingSet',value:function getTrainingSet(){return{docType:'rapid-mix:training-set',docVersion:_rapidMixAdapters.constants.rapidMixDocVersion,payload:{inputDimension:this.inputDimension,outputDimension:this.outputDimension,data:this.data}};}/**
   * Return an array of the current training set labels.
   *
   * @return {Array.String} - Training set sorted labels.
   */},{key:'getLabels',value:function getLabels(){var labels=[];for(var i=0;i<this.data.length;i++){var label=this.data[i].label;if(labels.indexOf(label)===-1)labels.push(label);}return labels.sort();}/**
   * Clear the whole training set.
   */},{key:'clear',value:function clear(){this._init();}/** @private */},{key:'_init',value:function _init(){if(!this.fixedDimensions){this.inputDimension=null;this.outputDimension=null;}this.data=[];}/**
   * Remove all examples of a certain label.
   *
   * @param {String} label - The label of the recordings to be removed.
   */},{key:'removeExamplesByLabel',value:function removeExamplesByLabel(label){this.data=this.data.filter(function(datum){return datum.label!==label;});}/**
   * Remove example at index.
   *
   * @param {Number} index - The index of the example to remove.
   */},{key:'removeExampleAtIndex',value:function removeExampleAtIndex(index){this.data.splice(index,1);}/**
   * Get the number of recordings.
   */},{key:'_checkDimensions',/** @private */value:function _checkDimensions(inputVector,outputVector){if(!isArray(inputVector)||outputVector&&!isArray(outputVector)){throw new Error('inputFrame and outputFrame must be arrays');}// set this back to true where appropriate if we add removeExample etc methods
if(!this.inputDimension||!this.outputDimension){this.inputDimension=inputVector.length;this.outputDimension=outputVector?outputVector.length:0;// this._empty = false;
}else if(inputVector.length!=this.inputDimension||outputVector.length!=this.outputDimension){throw new Error('dimensions mismatch');}}},{key:'length',get:function get(){return this.data.length;}}]);return TrainingData;}();exports.default=TrainingData;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbImlzQXJyYXkiLCJ2IiwiY29uc3RydWN0b3IiLCJGbG9hdDMyQXJyYXkiLCJGbG9hdDY0QXJyYXkiLCJBcnJheSIsIlRyYWluaW5nRGF0YSIsImlucHV0RGltZW5zaW9uIiwib3V0cHV0RGltZW5zaW9uIiwiY29sdW1uTmFtZXMiLCJmaXhlZERpbWVuc2lvbnMiLCJfaW5pdCIsImFyZ3MiLCJsZW5ndGgiLCJzbGljZSIsImxhYmVsIiwicmFwaWRNaXhEZWZhdWx0TGFiZWwiLCJpbnB1dFZlY3RvciIsIm91dHB1dFZlY3RvciIsIkVycm9yIiwiZSIsIkV4YW1wbGUiLCJzZXRMYWJlbCIsImFkZEVsZW1lbnQiLCJhZGRFeGFtcGxlIiwiZ2V0RXhhbXBsZSIsImV4YW1wbGUiLCJwYXlsb2FkIiwiX2NoZWNrRGltZW5zaW9ucyIsImlucHV0Iiwib3V0cHV0IiwiZGF0YSIsInB1c2giLCJ0cmFpbmluZ1NldCIsImV4YW1wbGVzIiwiaSIsInNldCIsImRvY1R5cGUiLCJkb2NWZXJzaW9uIiwicmFwaWRNaXhEb2NWZXJzaW9uIiwibGFiZWxzIiwiaW5kZXhPZiIsInNvcnQiLCJmaWx0ZXIiLCJkYXR1bSIsImluZGV4Iiwic3BsaWNlIl0sIm1hcHBpbmdzIjoiZ1VBQUEsb0QsbUZBRUE7QUFDQSxHQUFNQSxTQUFVLFFBQVZBLFFBQVUsR0FBSyxDQUNuQixNQUFPQyxHQUFFQyxXQUFGLEdBQWtCQyxZQUFsQixFQUNBRixFQUFFQyxXQUFGLEdBQWtCRSxZQURsQixFQUVBQyxNQUFNTCxPQUFOLENBQWNDLENBQWQsQ0FGUCxDQUdELENBSkQsQ0FNQTs7Ozs7Ozs7Ozs7Ozs7Ozs7O01BbUJNSyxhLFlBQ0osdUJBQTZFLElBQWpFQyxlQUFpRSwyREFBaEQsSUFBZ0QsSUFBMUNDLGdCQUEwQywyREFBeEIsSUFBd0IsSUFBbEJDLFlBQWtCLDJEQUFKLEVBQUksaURBQzNFLEdBQUlGLGlCQUFtQixJQUF2QixDQUE2QixDQUMzQixLQUFLRyxl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S04sY0FBM0IsRUFDRFcsYUFBYUwsTUFBYixFQUF1QixLQUFLTCxlQUQvQixDQUNnRCxDQUNyRCxLQUFNLElBQUlXLE1BQUosQ0FBVSxxQkFBVixDQUFOLENBQ0QsQ0FDRixDLGtDQWxCWSxDQUNYLE1BQU8sTUFBS1ksSUFBTCxDQUFVbEIsTUFBakIsQ0FDRCxDLDRDQW1CWVAsWSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbnN0YW50cyBhcyByYXBpZE1peENvbnN0YW50cyB9IGZyb20gJ3JhcGlkLW1peC1hZGFwdGVycyc7XG5cbi8vIHNvdXJjZSA6IGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzE1MjUxODc5L2hvdy10by1jaGVjay1pZi1hLXZhcmlhYmxlLWlzLWEtdHlwZWQtYXJyYXktaW4tamF2YXNjcmlwdFxuY29uc3QgaXNBcnJheSA9IHYgPT4ge1xuICByZXR1cm4gdi5jb25zdHJ1Y3RvciA9PT0gRmxvYXQzMkFycmF5IHx8XG4gICAgICAgICB2LmNvbnN0cnVjdG9yID09PSBGbG9hdDY0QXJyYXkgfHxcbiAgICAgICAgIEFycmF5LmlzQXJyYXkodik7XG59O1xuXG4vKipcbiAqIE1hbmFnZSBhbmQgZm9ybWF0IGEgc2V0IG9mIHJlY29yZGVkIGV4YW1wbGVzLCBtYWludGFpbiBhIFJhcGlkTWl4IGNvbXBsaWFudFxuICogdHJhaW5pbmcgc2V0LlxuICpcbiAqIEBwYXJhbSB7TnVtYmVyfSBbaW5wdXREaW1lbnNpb249bnVsbF0gLSBJbnB1dCBkaW1lbnNpb25cbiAqICAoaWYgYG51bGxgLCBpcyBndWVzc2VkIGZyb20gdGhlIGZpcnN0IHJlY29yZGVkIGVsZW1lbnQpXG4gKiBAcGFyYW0ge051bWJlcn0gW291dHB1dERpbWVuc2lvbj1udWxsXSAtIE91dHB1dCBkaW1lbnNpb24uXG4gKiAgKGlmIGBudWxsYCwgaXMgZ3Vlc3NlZCBmcm9tIHRoZSBmaXJzdCByZWNvcmRlZCBlbGVtZW50KS5cbiAqXG4gKiBAZXhhbXBsZVxuICogaW1wb3J0IHsgUHJvY2Vzc2VkU2Vuc29ycywgVHJhaW5pbmdEYXRhIH0gZnJvbSAnaW1sLW1vdGlvbic7XG4gKlxuICogY29uc3QgcHJvY2Vzc2VkU2Vuc29ycyA9IG5ldyBQcm9jZXNzZWRTZW5zb3JzKCk7XG4gKiBjb25zdCB0cmFpbmluZ0RhdGEgPSBuZXcgVHJhaW5pbmdEYXRhKDgpO1xuICpcbiAqIHByb2Nlc3NlZFNlbnNvcnMuYWRkTGlzdGVuZXIodHJhaW5pbmdEYXRhLmFkZEVsZW1lbnQpO1xuICogcHJvY2Vzc2VkU2Vuc29ycy5pbml0KClcbiAqICAgLnRoZW4oKCkgPT4gcHJvY2Vzc2VkU2Vuc29ycy5zdGFydCgpKTtcbiAqL1xuY2xhc3MgVHJhaW5pbmdEYXRhIHtcbiAgY29uc3RydWN0b3IoaW5wdXREaW1lbnNpb24gPSBudWxsLCBvdXRwdXREaW1lbnNpb24gPSBudWxsLCBjb2x1bW5OYW1lcyA9IFtdKSB7XG4gICAgaWYgKGlucHV0RGltZW5zaW9uICE9PSBudWxsKSB7XG4gICAgICB0aGlzLmZpeGVkRGltZW5zaW9ucyA9IHRydWU7XG4gICAgICB0aGlzLmlucHV0RGltZW5zaW9uID0gaW5wdXREaW1lbnNpb247XG4gICAgICB0aGlzLm91dHB1dERpbWVuc2lvbiA9IG91dHB1dERpbWVuc2lvbiAhPT0gbnVsbCA/IG91dHB1dERpbWVuc2lvbiA6IDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZml4ZWREaW1lbnNpb25zID0gZmFsc2U7XG4gICAgfVxuXG4gICAgdGhpcy5jb2x1bW5OYW1lcyA9IGNvbHVtbk5hbWVzO1xuICAgIHRoaXMuX2luaXQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYW4gZXhhbXBsZSBvZiBsZW5ndGggMSBjb250YWluaW5nIHRoZSBpbnB1dCBlbGVtZW50IGRhdGEgdG8gdGhlIHRyYWluaW5nIHNldC5cbiAgICogVmFsaWQgYXJndW1lbnQgY29tYmluYXRpb25zIGFyZSA6XG4gICAqIC0gKGlucHV0VmVjdG9yKVxuICAgKiAtIChpbnB1dFZlY3Rvciwgb3V0cHV0VmVjdG9yKVxuICAgKiAtIChsYWJlbCwgaW5wdXRWZWN0b3IpXG4gICAqIC0gKGxhYmVsLCBpbnB1dFZlY3Rvciwgb3V0cHV0VmVjdG9yKS5cbiAgICogTWVhbnQgdG8gYmUgYSBzaG9ydGN1dCB0byBhdm9pZCBjcmVhdGluZyBleGFtcGxlcyBvZiBsZW5ndGggMVxuICAgKiB3aGVuIGFkZGluZyBzaW5nbGUgZWxlbWVudHMgYXMgZXhhbXBsZXMuXG4gICAqXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBbbGFiZWw9cmFwaWRNaXhEZWZhdWx0TGFiZWxdIC0gVGhlIGxhYmVsIG9mIHRoZSBuZXcgZWxlbWVudC5cbiAgICogQHBhcmFtIHtBcnJheS5OdW1iZXJ8RmxvYXQzMkFycmF5fEZsb2F0NjRBcnJheX0gaW5wdXRWZWN0b3IgLSBUaGUgaW5wdXQgcGFydCBvZiB0aGUgbmV3IGVsZW1lbnQuXG4gICAqIEBwYXJhbSB7QXJyYXkuTnVtYmVyfEZsb2F0MzJBcnJheXxGbG9hdDY0QXJyYXl9IFtvdXRwdXRWZWN0b3I9bnVsbF0gLSBUaGUgb3V0cHV0IHBhcnQgb2YgdGhlIG5ldyBlbGVtZW50LlxuICAgKi9cbiAgYWRkRWxlbWVudCguLi5hcmdzKSB7XG4gICAgYXJncyA9IGFyZ3MubGVuZ3RoID4gMyA/IGFyZ3Muc2xpY2UoMCwgMykgOiBhcmdzO1xuXG4gICAgbGV0IGxhYmVsID0gcmFwaWRNaXhDb25zdGFudHMucmFwaWRNaXhEZWZhdWx0TGFiZWw7XG4gICAgbGV0IGlucHV0VmVjdG9yID0gbnVsbDtcbiAgICBsZXQgb3V0cHV0VmVjdG9yID0gbnVsbDtcblxuICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHtcbiAgICAgIGNhc2UgMDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdhZGRFbGVtZW50IG5lZWRzIGF0IGxlYXN0IGFuIGFycmF5IGFzIGFyZ3VtZW50Jyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAxOlxuICAgICAgICBpZiAoaXNBcnJheShhcmdzWzBdKSlcbiAgICAgICAgICBpbnB1dFZlY3RvciA9IGFyZ3NbMF07XG4gICAgICAgIGVsc2VcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NpbmdsZSBhcmd1bWVudCBtdXN0IGJlIGFuIGFycmF5Jyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAyOlxuICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnICYmIGlzQXJyYXkoYXJnc1sxXSkpIHtcbiAgICAgICAgICBsYWJlbCA9IGFyZ3NbMF07XG4gICAgICAgICAgaW5wdXRWZWN0b3IgPSBhcmdzWzFdO1xuICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoYXJnc1swXSkgJiYgaXNBcnJheShhcmdzWzFdKSkge1xuICAgICAgICAgIGlucHV0VmVjdG9yID0gYXJnc1swXTtcbiAgICAgICAgICBvdXRwdXRWZWN0b3IgPSBhcmdzWzFdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcigndHdvIGFyZ3VtZW50cyBjYW4gb25seSBiZSBlaXRoZXIgbGFiZWwgYW5kIGlucHV0VmVjdG9yLCBvciBpbnB1dFZlY3RvciBhbmQgb3V0cHV0VmVjdG9yJyk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDM6XG4gICAgICAgIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gJ3N0cmluZycgJiYgaXNBcnJheShhcmdzWzFdKSAmJiBpc0FycmF5KGFyZ3NbMl0pKSB7XG4gICAgICAgICAgbGFiZWwgPSBhcmdzWzBdO1xuICAgICAgICAgIGlucHV0VmVjdG9yID0gYXJnc1sxXTtcbiAgICAgICAgICBvdXRwdXRWZWN0b3IgPSBhcmdzWzJdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcigndGhyZWUgYXJndW1lbnRzIG11c3QgYmUgbGFiZWwsIGlucHV0VmVjdG9yIGFuZCBvdXRwdXRWZWN0b3InKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjb25zdCBlID0gbmV3IEV4YW1wbGUoKTtcbiAgICBlLnNldExhYmVsKGxhYmVsKTtcbiAgICBlLmFkZEVsZW1lbnQoaW5wdXRWZWN0b3IsIG91dHB1dFZlY3Rvcik7XG4gICAgdGhpcy5hZGRFeGFtcGxlKGUuZ2V0RXhhbXBsZSgpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYW4gZXhhbXBsZSB0byB0aGUgdHJhaW5pbmcgc2V0LlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gZXhhbXBsZSAtIEEgUmFwaWRNaXggZm9ybWF0dGVkIGV4YW1wbGUuXG4gICAqL1xuICBhZGRFeGFtcGxlKGV4YW1wbGUpIHtcbiAgICBjb25zdCBlID0gZXhhbXBsZS5wYXlsb2FkO1xuICAgIHRoaXMuX2NoZWNrRGltZW5zaW9ucyhlLmlucHV0WzBdLCBlLm91dHB1dFswXSk7XG5cbiAgICBpZiAoZS5pbnB1dC5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZXhhbXBsZXMgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBpbnB1dCB2ZWN0b3InKTtcbiAgICB9XG5cbiAgICB0aGlzLmRhdGEucHVzaCh7XG4gICAgICBsYWJlbDogZS5sYWJlbCxcbiAgICAgIGlucHV0OiBlLmlucHV0LFxuICAgICAgb3V0cHV0OiBlLm91dHB1dCxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYWxsIGV4YW1wbGVzIGZyb20gYW5vdGhlciB0cmFpbmluZyBzZXQuXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSB0cmFpbmluZ1NldCAtIEEgUmFwaWRNaXggY29tcGxpYW50IHRyYWluaW5nIHNldC5cbiAgICovXG4gIGFkZFRyYWluaW5nU2V0KHRyYWluaW5nU2V0KSB7XG4gICAgY29uc3QgZXhhbXBsZXMgPSB0cmFpbmluZ1NldC5wYXlsb2FkLmRhdGE7XG4gICAgbGV0IGUgPSBleGFtcGxlc1swXTtcbiAgICB0aGlzLl9jaGVja0RpbWVuc2lvbnMoZS5pbnB1dFswXSwgZS5vdXRwdXRbMF0pO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBleGFtcGxlcy5sZW5ndGg7IGkrKykge1xuICAgICAgZSA9IGV4YW1wbGVzW2ldO1xuXG4gICAgICB0aGlzLmRhdGEucHVzaCh7XG4gICAgICAgIGxhYmVsOiBlLmxhYmVsLFxuICAgICAgICBpbnB1dDogZS5pbnB1dCxcbiAgICAgICAgb3V0cHV0OiBlLm91dHB1dCxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIGludGVybmFsIGRhdGEgZnJvbSBhbm90aGVyIHRyYWluaW5nIHNldC5cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IHRyYWluaW5nU2V0IC0gQSBSYXBpZE1peCBjb21wbGlhbnQgdHJhaW5pbmcgc2V0LlxuICAgKi9cbiAgc2V0VHJhaW5pbmdTZXQodHJhaW5pbmdTZXQpIHtcbiAgICBpZiAoIXRyYWluaW5nU2V0KSB7XG4gICAgICB0aGlzLl9pbml0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qgc2V0ID0gdHJhaW5pbmdTZXQucGF5bG9hZDtcblxuICAgIHRoaXMuaW5wdXREaW1lbnNpb24gPSBzZXQuaW5wdXREaW1lbnNpb247XG4gICAgdGhpcy5vdXRwdXREaW1lbnNpb24gPSBzZXQub3V0cHV0RGltZW5zaW9uO1xuICAgIHRoaXMuZGF0YSA9IHNldC5kYXRhO1xuICAgIHRoaXMuY29sdW1uTmFtZXMgPSBzZXQuY29sdW1uTmFtZXM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIHRoZSBSYXBpZE1peCBjb21wbGlhbnQgdHJhaW5pbmcgc2V0IGluIEpTT04gZm9ybWF0LlxuICAgKlxuICAgKiBAcmV0dXJuIHtPYmplY3R9IC0gVHJhaW5pbmcgc2V0LlxuICAgKi9cbiAgZ2V0VHJhaW5pbmdTZXQoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGRvY1R5cGU6ICdyYXBpZC1taXg6dHJhaW5pbmctc2V0JyxcbiAgICAgIGRvY1ZlcnNpb246IHJhcGlkTWl4Q29uc3RhbnRzLnJhcGlkTWl4RG9jVmVyc2lvbixcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgaW5wdXREaW1lbnNpb246IHRoaXMuaW5wdXREaW1lbnNpb24sXG4gICAgICAgIG91dHB1dERpbWVuc2lvbjogdGhpcy5vdXRwdXREaW1lbnNpb24sXG4gICAgICAgIGRhdGE6IHRoaXMuZGF0YSxcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBhbiBhcnJheSBvZiB0aGUgY3VycmVudCB0cmFpbmluZyBzZXQgbGFiZWxzLlxuICAgKlxuICAgKiBAcmV0dXJuIHtBcnJheS5TdHJpbmd9IC0gVHJhaW5pbmcgc2V0IHNvcnRlZCBsYWJlbHMuXG4gICAqL1xuICBnZXRMYWJlbHMoKSB7XG4gICAgY29uc3QgbGFiZWxzID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgbGFiZWwgPSB0aGlzLmRhdGFbaV0ubGFiZWw7XG5cbiAgICAgIGlmIChsYWJlbHMuaW5kZXhPZihsYWJlbCkgPT09IC0xKVxuICAgICAgICBsYWJlbHMucHVzaChsYWJlbCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGxhYmVscy5zb3J0KCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgdGhlIHdob2xlIHRyYWluaW5nIHNldC5cbiAgICovXG4gIGNsZWFyKCkge1xuICAgIHRoaXMuX2luaXQoKTtcbiAgfVxuXG4gIC8qKiBAcHJpdmF0ZSAqL1xuICBfaW5pdCgpIHtcbiAgICBpZiAoIXRoaXMuZml4ZWREaW1lbnNpb25zKSB7XG4gICAgICB0aGlzLmlucHV0RGltZW5zaW9uID0gbnVsbDtcbiAgICAgIHRoaXMub3V0cHV0RGltZW5zaW9uID0gbnVsbDtcbiAgICB9XG5cbiAgICB0aGlzLmRhdGEgPSBbXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYWxsIGV4YW1wbGVzIG9mIGEgY2VydGFpbiBsYWJlbC5cbiAgICpcbiAgICogQHBhcmFtIHtTdHJpbmd9IGxhYmVsIC0gVGhlIGxhYmVsIG9mIHRoZSByZWNvcmRpbmdzIHRvIGJlIHJlbW92ZWQuXG4gICAqL1xuICByZW1vdmVFeGFtcGxlc0J5TGFiZWwobGFiZWwpIHtcbiAgICB0aGlzLmRhdGEgPSB0aGlzLmRhdGEuZmlsdGVyKGRhdHVtID0+IGRhdHVtLmxhYmVsICE9PSBsYWJlbCk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGV4YW1wbGUgYXQgaW5kZXguXG4gICAqXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGUgZXhhbXBsZSB0byByZW1vdmUuXG4gICAqL1xuICByZW1vdmVFeGFtcGxlQXRJbmRleChpbmRleCkge1xuICAgIHRoaXMuZGF0YS5zcGxpY2UoaW5kZXgsIDEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgbnVtYmVyIG9mIHJlY29yZGluZ3MuXG4gICAqL1xuICBnZXQgbGVuZ3RoKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGEubGVuZ3RoO1xuICB9XG5cbiAgLyoqIEBwcml2YXRlICovXG4gIF9jaGVja0RpbWVuc2lvbnMoaW5wdXRWZWN0b3IsIG91dHB1dFZlY3RvcinCoHtcbiAgICBpZiAoIWlzQXJyYXkoaW5wdXRWZWN0b3IpIHx8IChvdXRwdXRWZWN0b3IgJiYgIWlzQXJyYXkob3V0cHV0VmVjdG9yKSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignaW5wdXRGcmFtZSBhbmQgb3V0cHV0RnJhbWUgbXVzdCBiZSBhcnJheXMnKTtcbiAgICB9XG4gICAgLy8gc2V0IHRoaXMgYmFjayB0byB0cnVlIHdoZXJlIGFwcHJvcHJpYXRlIGlmIHdlIGFkZCByZW1vdmVFeGFtcGxlIGV0YyBtZXRob2RzXG4gICAgaWYgKCF0aGlzLmlucHV0RGltZW5zaW9uIHx8ICF0aGlzLm91dHB1dERpbWVuc2lvbikge1xuICAgICAgdGhpcy5pbnB1dERpbWVuc2lvbiA9IGlucHV0VmVjdG9yLmxlbmd0aDtcbiAgICAgIHRoaXMub3V0cHV0RGltZW5zaW9uID0gb3V0cHV0VmVjdG9yID8gb3V0cHV0VmVjdG9yLmxlbmd0aCA6IDA7XG4gICAgICAvLyB0aGlzLl9lbXB0eSA9IGZhbHNlO1xuICAgIH0gZWxzZSBpZiAoaW5wdXRWZWN0b3IubGVuZ3RoICE9IHRoaXMuaW5wdXREaW1lbnNpb24gfHxcbiAgICAgICAgICAgICAgb3V0cHV0VmVjdG9yLmxlbmd0aCAhPSB0aGlzLm91dHB1dERpbWVuc2lvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdkaW1lbnNpb25zIG1pc21hdGNoJyk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRyYWluaW5nRGF0YTtcbiJdfQ==